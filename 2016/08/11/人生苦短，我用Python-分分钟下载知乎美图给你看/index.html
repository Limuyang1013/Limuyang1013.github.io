<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="人生苦短，我用Python--分分钟下载知乎美图给你看"><meta name="keywords" content="知乎,爬虫,数据采集"><meta name="author" content="李牧羊,lin794653318@gmail.com"><meta name="copyright" content="李牧羊"><title>人生苦短，我用Python--分分钟下载知乎美图给你看 | Atlantis</title><link rel="shortcut icon" href="/source/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#起"><span class="toc-number">1.</span> <span class="toc-text">起</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#承"><span class="toc-number">2.</span> <span class="toc-text">承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转"><span class="toc-number">3.</span> <span class="toc-text">转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#合"><span class="toc-number">4.</span> <span class="toc-text">合</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.tuchuang001.com/images/2018/04/27/3-15052H1035cF.jpg"></div><div class="author-info__name text-center">李牧羊</div><div class="author-info__description text-center">碌碌无为，打马而过</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">22</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">39</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://litten.me/" target="_blank">litten</a><a class="author-info-links__name text-center" href="https://developer.android.com/index.html" target="_blank">Android Developer</a><a class="author-info-links__name text-center" href="http://blog.csdn.net/wei_smile" target="_blank">CSDN</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fnp7q2phkzj21hc0xc0yl)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Atlantis</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/categories/Android/">移动开发</a><a class="site-page" href="/categories/Python/">爬虫</a><a class="site-page" href="/categories/旧事/">旧事</a><a class="site-page" href="/categories/前端开发/">前端开发</a></span></div><div id="post-info"><div id="post-title">人生苦短，我用Python--分分钟下载知乎美图给你看</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-08-11</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/"></span></a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2,138</span><span class="post-meta__separator">|</span><span>阅读时长: 9 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h3 id="起"><a href="#起" class="headerlink" title="起"></a>起</h3><p>上次说了要爬知乎的图片，于是花了一下午的时间去完成这件事，发现暂时接触到的爬虫总是逃脱不了一个规律：</p>
<ul>
<li>模拟登陆</li>
<li>获取真实网页HTML源代码</li>
<li>解析获取到的网页源代码</li>
<li>获取想要的资源(下载到某个文件夹或者输出到表格中整合起来)</li>
</ul>
<p>也许和我说的有一些出入，应该是刚学这个东西的原因，接下来还想研究一下多线程爬虫、添加代理、爬取海量数据并整合成图表形式，先把能做的做了。</p>
<a id="more"></a>
<h3 id="承"><a href="#承" class="headerlink" title="承"></a>承</h3><p>因为是在上一次的基础上进行的，所以没有看<a href="http://www.limuyang.cc/2016/08/09/%E4%BA%BA%E7%94%9F%E8%8B%A6%E7%9F%AD%EF%BC%8C%E6%88%91%E7%94%A8Python-%E4%B8%80%E8%B5%B7%E6%9D%A5%E7%88%AC%E7%9F%A5%E4%B9%8E%E5%A8%98/" target="_blank" rel="external"><strong>上一篇文章</strong></a>的可以先看一下，这里用到的工具跟之前一样：</p>
<ul>
<li>win7 64位 旗舰版</li>
<li>Python 3.5 64-bit</li>
<li>PyCharm</li>
</ul>
<p>这里模拟登陆是跟之前一样的代码，直接贴就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">logn_url = <span class="string">'http://www.zhihu.com/#signin'</span></div><div class="line"></div><div class="line">session = requests.session()</div><div class="line"></div><div class="line">headers = &#123;</div><div class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.82 Safari/537.36'</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line">content = session.get(logn_url, headers=headers).content</div><div class="line">soup = BeautifulSoup(content, <span class="string">'html.parser'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getxsrf</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> soup.find(<span class="string">'input'</span>, attrs=&#123;<span class="string">'name'</span>: <span class="string">"_xsrf"</span>&#125;)[<span class="string">'value'</span>]</div><div class="line">    <span class="comment"># 获取验证码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha</span><span class="params">()</span>:</span></div><div class="line">    t = str(int(time.time() * <span class="number">1000</span>))</div><div class="line">    captcha_url = <span class="string">'http://www.zhihu.com/captcha.gif?r='</span> + t + <span class="string">"&amp;type=login"</span></div><div class="line">    r = session.get(captcha_url, headers=headers)</div><div class="line">    <span class="keyword">with</span> open(<span class="string">'captcha.jpg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">        f.write(r.content)</div><div class="line">        f.close()</div><div class="line">    <span class="comment"># 用pillow 的 Image 显示验证码</span></div><div class="line">    <span class="comment"># 如果没有安装 pillow 到源代码所在的目录去找到验证码然后手动输入</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        im = Image.open(<span class="string">'captcha.jpg'</span>)</div><div class="line">        im.show()</div><div class="line">        im.close()</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        print(<span class="string">u'请到 %s 目录找到captcha.jpg 手动输入'</span> % os.path.abspath(<span class="string">'captcha.jpg'</span>))</div><div class="line">    captcha = input(<span class="string">"please input the captcha\n&gt;"</span>)</div><div class="line">    <span class="keyword">return</span> captcha</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">isLogin</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># 通过查看用户个人信息来判断是否已经登录</span></div><div class="line">    url = <span class="string">"https://www.zhihu.com/settings/profile"</span></div><div class="line">    login_code = session.get(url, allow_redirects=<span class="keyword">False</span>).status_code</div><div class="line">    <span class="keyword">if</span> int(x=login_code) == <span class="number">200</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(secret, account)</span>:</span></div><div class="line">    <span class="comment"># 通过输入的用户名判断是否是手机号</span></div><div class="line">    <span class="keyword">if</span> re.match(<span class="string">r"^1\d&#123;10&#125;$"</span>, account):</div><div class="line">        print(<span class="string">"手机号登录 \n"</span>)</div><div class="line">        post_url = <span class="string">'http://www.zhihu.com/login/phone_num'</span></div><div class="line">        postdata = &#123;</div><div class="line">            <span class="string">'_xsrf'</span>: getxsrf(),</div><div class="line">            <span class="string">'password'</span>: secret,</div><div class="line">            <span class="string">'remember_me'</span>: <span class="string">'true'</span>,</div><div class="line">            <span class="string">'phone_num'</span>: account,</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(<span class="string">"邮箱登录 \n"</span>)</div><div class="line">        post_url = <span class="string">'http://www.zhihu.com/login/email'</span></div><div class="line">        postdata = &#123;</div><div class="line">            <span class="string">'_xsrf'</span>: getxsrf(),</div><div class="line">            <span class="string">'password'</span>: secret,</div><div class="line">            <span class="string">'remember_me'</span>: <span class="string">'true'</span>,</div><div class="line">            <span class="string">'email'</span>: account,</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># 不需要验证码直接登录成功</span></div><div class="line">        login_page = session.post(post_url, data=postdata, headers=headers)</div><div class="line">        login_code = login_page.text</div><div class="line">        print(login_page.status)</div><div class="line">        print(login_code)</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="comment"># 需要输入验证码后才能登录成功</span></div><div class="line">        postdata[<span class="string">"captcha"</span>] = get_captcha()</div><div class="line">        login_page = session.post(post_url, data=postdata, headers=headers)</div><div class="line">        login_code = eval(login_page.text)</div><div class="line">        print(login_code[<span class="string">'msg'</span>])</div></pre></td></tr></table></figure>
<p>这里的代码来自GitHub上的<a href="https://github.com/xchaoinfo/fuck-login" target="_blank" rel="external"><strong>fuck-login</strong></a>项目，在此表示感谢，我在原始代码上进行了改进，原始代码是适配了Python2.x和Python3.x，但是我学的是Python3.x所以去掉了一些我没用过的模块，也就是说我改进了后的代码是适用于Python3.x的。</p>
<p>下面就是准备获取图片了，先找一个目标，最近有一个问题很火：</p>
<blockquote>
<p><a href="https://www.zhihu.com/question/37709992" target="_blank" rel="external"><strong>长得好看，但没有男朋友是怎样的体验</strong></a></p>
</blockquote>
<p>还记得我列出来的步骤么，模拟登陆之后是获取真实的网页源代码，什么叫真实的，这个问题问得好，你没发现知乎很喜欢用动态加载技术么，也就是说，你看到的只是表象，这里也一样。</p>
<h3 id="转"><a href="#转" class="headerlink" title="转"></a>转</h3><p><img src="http://oasusatoz.bkt.clouddn.com/%E9%97%AE%E9%A2%98%E7%95%8C%E9%9D%A2.png" alt="问题界面"></p>
<p>来，我们先点开点赞数最高的妹子上传的图片：</p>
<p><img src="http://oasusatoz.bkt.clouddn.com/beauty.png" alt="Beauty"></p>
<p>咳咳咳，好像跑偏了，我们的目标是星辰大海，正确的做法是鼠标右键查看网页源代码：</p>
<p><img src="http://oasusatoz.bkt.clouddn.com/%E7%BD%91%E9%A1%B5%E6%BA%90%E4%BB%A3%E7%A0%81.png" alt="网页源代码"></p>
<p>是不是看到了很多图片链接，当然我们要找.jpg、.jpeg、.png后缀的：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">data-rawwidth</span>=<span class="string">"1632"</span> <span class="attr">data-rawheight</span>=<span class="string">"2040"</span> <span class="attr">src</span>=<span class="string">"//zhstatic.zhihu.com/assets/zhihu/ztext/whitedot.jpg"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb lazy"</span> <span class="attr">width</span>=<span class="string">"1632"</span> <span class="attr">data-original</span>=<span class="string">"https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_r.jpg"</span> <span class="attr">data-actualsrc</span>=<span class="string">"https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_b.jpg"</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>这里有两个：<code>data-original</code>和<code>data-actualsrc</code>，实际查看的图片是<code>data-original</code>的图片比<code>data-actualsrc</code>的大，下载下来也是如此，但是因为是使用正则去匹配规则，而<code>data-original</code>有多项，上面代码只是贴出来的一部分，实际匹配的结果类似这样：</p>
<p>data-actualsrc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data-actualsrc=&quot;https://pic2.zhimg.com/be7600989233bdf438e5ba23f2cdb685_b.jpg&quot;&gt;</div><div class="line">data-actualsrc=&quot;https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_b.jpg&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>data-original</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">data-original=&quot;https://pic2.zhimg.com/be7600989233bdf438e5ba23f2cdb685_r.jpg&quot;&gt;</div><div class="line">data-original=&quot;https://pic2.zhimg.com/be7600989233bdf438e5ba23f2cdb685_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/be7600989233bdf438e5ba23f2cdb685_b.jpg&quot;&gt;</div><div class="line">data-original=&quot;https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_r.jpg&quot;&gt;</div><div class="line">data-original=&quot;https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/b6274542f3785c27ab4a38d4db906efd_b.jpg&quot;&gt;</div><div class="line">data-original=&quot;https://pic2.zhimg.com/0930549116d22ffce22e98c32683d621_r.jpg&quot;&gt;</div></pre></td></tr></table></figure>
<p>这是在同一段网页源码测试下的结果，匹配后一种会得到多个相同的url地址，解析起来也更麻烦，这也跟正则写的简单有关系，有兴趣的可以到时候自己修改一下正则表达式，这样下下来的图片也更高清的多。</p>
<p>分析了正则，下面要获取所有的图片该分析Chrome开发者面板的Post数据，因为知乎默认只显示部分回答，我们可以不断往下拉，直到看到这个：</p>
<p><img src="http://oasusatoz.bkt.clouddn.com/more.png" alt="更多"></p>
<p>点击的时候注意观察开发者面板：</p>
<p><img src="http://oasusatoz.bkt.clouddn.com/%E7%82%B9%E5%87%BB%E6%9B%B4%E5%A4%9A%E6%97%B6%E4%BC%A0%E9%80%92%E7%9A%84%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE.png" alt="enter image description here"></p>
<p>简直完美，传递的数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">method:next</div><div class="line">params:&#123;&quot;url_token&quot;:37709992,&quot;pagesize&quot;:10,&quot;offset&quot;:30&#125;</div></pre></td></tr></table></figure>
<p>很眼熟，<code>url_token</code>就是问题后面那串数字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://www.zhihu.com/question/37709992</div></pre></td></tr></table></figure>
<p><code>pagesize</code>是固定的10，最后一个<code>offset</code>偏移量同样很好理解，这里显示10应该说的就是默认显示的10个答案，后面还查看到如下数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">method:next</div><div class="line">params:&#123;&quot;url_token&quot;:37709992,&quot;pagesize&quot;:10,&quot;offset&quot;:20&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">method:next</div><div class="line">params:&#123;&quot;url_token&quot;:37709992,&quot;pagesize&quot;:10,&quot;offset&quot;:30&#125;</div></pre></td></tr></table></figure>
<p>也就是说我们在浏览器上每翻过10个答案浏览器就会向服务器发送Post请求在加载十个答案，恩差不多可以开始写代码了。</p>
<h3 id="合"><a href="#合" class="headerlink" title="合"></a>合</h3><p>模拟登陆之后的操作是找到Post的真实地址模拟浏览器向服务器发送请求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">url = <span class="string">'https://www.zhihu.com/node/QuestionAnswerListV2'</span></div><div class="line">header = &#123;</div><div class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.82 Safari/537.36'</span>,</div><div class="line">    <span class="string">'Referer'</span>: <span class="string">'https://www.zhihu.com/question/37709992'</span>,</div><div class="line">    <span class="string">'Origin'</span>: <span class="string">'https://www.zhihu.com'</span>,</div><div class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</div><div class="line">&#125;</div><div class="line">data = &#123;</div><div class="line">    <span class="string">'method'</span>: <span class="string">'next'</span>,</div><div class="line">    <span class="string">'params'</span>: <span class="string">'&#123;"url_token":'</span> + str(<span class="number">37709992</span>) + <span class="string">',"pagesize": "10",'</span> + \</div><div class="line">              <span class="string">'"offset":'</span> + str(offset) + <span class="string">"&#125;"</span>,</div><div class="line">    <span class="string">'_xsrf'</span>: getxsrf(),</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>发送Post请求时候请加上<code>&#39;_xsrf&#39;: getxsrf()</code>这一行，否则的话返回的只会是<code>404 Forbidden</code>，应该是做了防伪登陆的缘故</p>
<p>然后是写正则，这里发现图片都是被包含在这里面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"zm-editable-content clearfix"</span>&gt;</span></div><div class="line">...</div><div class="line">...</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>所以先匹配到这一大串内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pattern = re.compile(<span class="string">'&lt;a class="author-link".*?&lt;span title=.*?&lt;div class="zh-summary.*?'</span> +</div><div class="line">                     <span class="string">'&lt;div class="zm-editable-content.*?&gt;(.*?)&lt;/div&gt;'</span>, re.S)</div></pre></td></tr></table></figure>
<p>然后在匹配<code>data-actualsrc</code>里面的图片链接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pattern = re.compile(<span class="string">'data-actualsrc="(.*?)"&gt;'</span>, re.S)</div></pre></td></tr></table></figure>
<p>还有一点要注意的是我们请求之后返回来的是json格式的数据，所以这里还要用到json模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">question = session.post(url, headers=header, data=data)</div><div class="line">dic = json.loads(question.content.decode(<span class="string">'ISO-8859-1'</span>))</div><div class="line">li = dic[<span class="string">'msg'</span>][<span class="number">0</span>]</div></pre></td></tr></table></figure>
<p>然后对其进行解析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里使用的是第一个正则表达式</span></div><div class="line">items = re.findall(pattern, li)</div><div class="line"><span class="comment"># 接下来</span></div><div class="line">items = re.findall(pattern, li)</div><div class="line"><span class="comment"># 存储图片链接</span></div><div class="line">imagesurl = []</div><div class="line">pattern = re.compile(<span class="string">'data-actualsrc="(.*?)"&gt;'</span>, re.S)</div><div class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">    urls = re.findall(pattern, item)</div><div class="line">    imagesurl.extend(urls)</div></pre></td></tr></table></figure>
<p>执行下载操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 存放图片的地址</span></div><div class="line">PWD = <span class="string">"D:/work/python/zhihu/"</span></div><div class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> imagesurl:</div><div class="line">            myurl = url</div><div class="line">            filename = PWD + str(count) + <span class="string">'.jpg'</span></div><div class="line">            <span class="keyword">if</span> os.path.isfile(filename):</div><div class="line">                print(<span class="string">"文件存在："</span>, filename)</div><div class="line">                count += <span class="number">1</span></div><div class="line">                <span class="keyword">continue</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># 执行下载操作的方法</span></div><div class="line">                downpic(filename, myurl)</div><div class="line">                count += <span class="number">1</span></div><div class="line">                photoNum += <span class="number">1</span></div><div class="line">            print(<span class="string">"一共下载了&#123;0&#125; 张照片"</span>.format(photoNum))</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(PWD):</div><div class="line">                os.makedirs(PWD)</div><div class="line">                <span class="comment"># 递归调用</span></div><div class="line">        change(offset, count, photoNum)</div><div class="line"></div><div class="line"><span class="comment"># downpic方法源码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">downpic</span><span class="params">(filename, url)</span>:</span></div><div class="line">    print(<span class="string">"正在下载 "</span> + url)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        r = requests.get(url, stream=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">with</span> open(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> fd:</div><div class="line">            <span class="keyword">for</span> chunk <span class="keyword">in</span> r.iter_content():</div><div class="line">                fd.write(chunk)</div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        print(<span class="string">"下载失败了"</span>, e)</div></pre></td></tr></table></figure>
<p><strong>运行结果</strong></p>
<p><img src="http://oasusatoz.bkt.clouddn.com/%E4%B8%8B%E8%BD%BD%E7%BE%8E%E5%9B%BE.gif" alt="运行结果"></p>
<p><img src="http://oasusatoz.bkt.clouddn.com/%E5%9B%BE%E7%89%87.png" alt="结果"></p>
<p>这只是一部分，我之前下了四五百张还在下~当然这是后话，感觉现在写的东西都很简单，希望下一次能写出难一点的东西出来。</p>
<p>这里正则部分参考了这里：</p>
<blockquote>
<p><a href="http://blog.csdn.net/willib/article/details/51873259" target="_blank" rel="external"><strong>通过Python爬虫爬取知乎某个问题下的图片</strong></a></p>
</blockquote>
<p>最后是<a href="https://github.com/GiitSmile/downloadpic.py" target="_blank" rel="external"><strong>源码</strong></a></p>
<p>源码中注释部分只能下载前十个答案里包含的图片的方法，还有一些想法未完成，本来是想打印一下正在下载哪个答主的回答，然后把图片分别保存到相应的单独文件夹，实现起来有点麻烦就没去搞，仅供参考。</p>
<p>亲测如果需要下载另一个问题的答案，只需要在:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">data = &#123;</div><div class="line">       &apos;method&apos;: &apos;next&apos;,</div><div class="line">       &apos;params&apos;: &apos;&#123;&quot;url_token&quot;:&apos; + str(37709992) + &apos;,&quot;pagesize&quot;: &quot;10&quot;,&apos; + \</div><div class="line">                 &apos;&quot;offset&quot;:&apos; + str(offset) + &quot;&#125;&quot;,</div><div class="line">       &apos;_xsrf&apos;: getxsrf(),</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>更换那串数字就行，就好比这样的形式：</p>
<blockquote>
<p><a href="https://www.zhihu.com/question/48720845" target="_blank" rel="external">https://www.zhihu.com/question/48720845</a></p>
</blockquote>
<p>但是这种形式的把数字换上去不起效：</p>
<blockquote>
<p><a href="https://www.zhihu.com/question/49078894#answer-41776282" target="_blank" rel="external">https://www.zhihu.com/question/49078894#answer-41776282</a></p>
</blockquote>
<p>这个好像是知乎热门问答的链接形式，暂时没有深究</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:lin794653318@gmail.com">李牧羊</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https:///www.limuyang.cc/2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/">https:///www.limuyang.cc/2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https:///www.limuyang.cc" target="_blank">Atlantis</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/知乎/">知乎</a><a class="post-meta__tags" href="/tags/爬虫/">爬虫</a><a class="post-meta__tags" href="/tags/数据采集/">数据采集</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img"><div class="post-qr-code__desc"></div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/10/29/Handler机制从入门到放弃-一/"><i class="fa fa-chevron-left">  </i><span>Handler机制从入门到放弃(一)</span></a></div><div class="next-post pull-right"><a href="/2016/08/09/人生苦短，我用Python-一起来爬知乎娘/"><span>人生苦短，我用Python--一起来爬知乎娘</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https:///www.limuyang.cc/2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/';
  this.page.identifier = '2016/08/11/人生苦短，我用Python-分分钟下载知乎美图给你看/';
  this.page.title = '人生苦短，我用Python--分分钟下载知乎美图给你看';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Limuyang' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://Limuyang.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By 李牧羊</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>