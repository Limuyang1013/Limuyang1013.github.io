<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="阅读分析React-Redux源码"><meta name="keywords" content="javascript,源码阅读,react-redux"><meta name="author" content="李牧羊,lin794653318@gmail.com"><meta name="copyright" content="李牧羊"><title>阅读分析React-Redux源码 | Atlantis</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"HJB2USV1FL","apiKey":"fb4cc72114f6ad072b67049aa8e6b5c6","indexName":"Limuyang","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Index"><span class="toc-number">1.</span> <span class="toc-text">Index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Provider"><span class="toc-number">2.</span> <span class="toc-text">Provider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Connect"><span class="toc-number">3.</span> <span class="toc-text">Connect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#connectAdvanced"><span class="toc-number">4.</span> <span class="toc-text">connectAdvanced</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.tuchuang001.com/images/2018/04/27/3-15052H1035cF.jpg"></div><div class="author-info__name text-center">李牧羊</div><div class="author-info__description text-center">大海与冷笑话</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">30</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">49</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://litten.me/" target="_blank">litten</a><a class="author-info-links__name text-center" href="https://developer.mozilla.org/zh-CN/" target="_blank">MDN</a><a class="author-info-links__name text-center" href="http://blog.csdn.net/wei_smile" target="_blank">CSDN</a><a class="author-info-links__name text-center" href="https://cn.vuejs.org/" target="_blank">Vuejs</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/9f814a87gy1g0s6n93k0tj215d0nagzu.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Atlantis</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/categories/Android/">移动开发</a><a class="site-page" href="/categories/Python/">爬虫</a><a class="site-page" href="/categories/旧事/">旧事</a><a class="site-page" href="/categories/前端开发/">前端开发</a></span></div><div id="post-info"><div id="post-title">阅读分析React-Redux源码</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/前端开发/">前端开发</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2019/06/19/阅读分析React-Redux源码/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2019/06/19/阅读分析React-Redux源码/"></span></a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4,502</span><span class="post-meta__separator">|</span><span>阅读时长: 22 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><p>redux作为大型应用的状态管理工具，如果想配合react使用，需要借助react-redux。 redux主要完成两件事情：</p>
<ul>
<li>通过<code>context</code>从<code>root</code>向下传入<code>store</code>，保证数据的单项流动的同时也方便了子组件从<code>store</code>上获取数据</li>
<li>当应用状态发生变化，触发<code>subscribe</code>方法进行监听，实现相关逻辑</li>
</ul>
<blockquote>
<p>在<code>React 16.4.0</code>之前，<code>React</code>官方是不推荐使用<code>context</code>的，原因在于，当<code>context</code>中的值刷新的时候，是从上到下刷新的，如果中间有组件的<code>shouldComponentUpdate</code>返回了<code>false</code>，这个组件下面的组件就收不到更新后的值；而<code>React-Redux</code>实现了订阅发布的模式，保证使用了<code>store</code>的组件在数据更新的时候可以得到通知。<br>在<code>React 16.4.0</code>之后官方将<code>createContext</code>暴露出来了，以上的问题不会出现，但是是不是意味着，可以用<code>context</code>来替代<code>redux</code>呢？理论上是可以的，但是并不推荐这样做，因为在<code>redux</code>的发展中，其生态系统是非常繁荣的，用<code>Redux</code>能避免重复造轮子的窘境。<br>引自：<a href="http://cuteshilina.com/2019/01/19/HowReactReduxWorks/#我们为什么需要react-redux" target="_blank" rel="noopener">http://cuteshilina.com/2019/01/19/HowReactReduxWorks/#我们为什么需要react-redux</a><br><a id="more"></a><br>看一眼React-Redux的目录结构：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">├── components</span><br><span class="line">│   ├── Context.js</span><br><span class="line">│   ├── Provider.js</span><br><span class="line">│   └── connectAdvanced.js</span><br><span class="line">├── connect</span><br><span class="line">│   ├── connect.js</span><br><span class="line">│   ├── mapDispatchToProps.js</span><br><span class="line">│   ├── mapStateToProps.js</span><br><span class="line">│   ├── mergeProps.js</span><br><span class="line">│   ├── selectorFactory.js</span><br><span class="line">│   ├── verifySubselectors.js</span><br><span class="line">│   └── wrapMapToProps.js</span><br><span class="line">├── index.js</span><br><span class="line">└── utils</span><br><span class="line">    ├── isPlainObject.js</span><br><span class="line">    ├── shallowEqual.js</span><br><span class="line">    ├── verifyPlainObject.js</span><br></pre></td></tr></table></figure>
<p>入口在<code>index.js</code>：</p>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Provider <span class="keyword">from</span> <span class="string">'./components/Provider'</span></span><br><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">'./components/connectAdvanced'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ReactReduxContext &#125; <span class="keyword">from</span> <span class="string">'./components/Context'</span></span><br><span class="line"><span class="keyword">import</span> connect <span class="keyword">from</span> <span class="string">'./connect/connect'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; Provider, connectAdvanced, ReactReduxContext, connect &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到入口只是对外输出了<code>Provider</code>、<code>connenct</code>、<code>connectedAdvanced</code>三个方法，我们常用的是前面两种方法。</p>
<p>先看Provider。</p>
<h4 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ReactReduxContext &#125; <span class="keyword">from</span> <span class="string">'./Context'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">    <span class="comment">// 获取store</span></span><br><span class="line">    <span class="keyword">const</span> &#123; store &#125; = props</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      storeState: store.getState(),</span><br><span class="line">      store</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// 判断是否挂载的flag</span></span><br><span class="line">    <span class="keyword">this</span>._isMounted = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.subscribe()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.unsubscribe) <span class="keyword">this</span>.unsubscribe()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._isMounted = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.store !== prevProps.store) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.unsubscribe) <span class="keyword">this</span>.unsubscribe()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.subscribe()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  subscribe() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.unsubscribe = store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取最新的state</span></span><br><span class="line">      <span class="keyword">const</span> newStoreState = store.getState()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>._isMounted) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 更新storeState</span></span><br><span class="line">      <span class="keyword">this</span>.setState(<span class="function"><span class="params">providerState</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// If the value is the same, skip the unnecessary state update.</span></span><br><span class="line">        <span class="keyword">if</span> (providerState.storeState === newStoreState) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">storeState</span>: newStoreState &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actions might have been dispatched between render and mount - handle those</span></span><br><span class="line">    <span class="keyword">const</span> postMountStoreState = store.getState()</span><br><span class="line">    <span class="keyword">if</span> (postMountStoreState !== <span class="keyword">this</span>.state.storeState) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">storeState</span>: postMountStoreState &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> Context = <span class="keyword">this</span>.props.context || ReactReduxContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Context.Provider value=&#123;<span class="keyword">this</span>.state&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">      &lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Provider.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  store: PropTypes.shape(&#123;</span></span><br><span class="line"><span class="regexp">    subscribe: PropTypes.func.isRequired,</span></span><br><span class="line"><span class="regexp">    dispatch: PropTypes.func.isRequired,</span></span><br><span class="line"><span class="regexp">    getState: PropTypes.func.isRequired</span></span><br><span class="line"><span class="regexp">  &#125;),</span></span><br><span class="line"><span class="regexp">  context: PropTypes.object,</span></span><br><span class="line"><span class="regexp">  children: PropTypes.any</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Provider</span></span><br></pre></td></tr></table></figure>
<p>我们在使用Provider的时候只需要把<code>Store</code>传入，通过<code>Context</code>这个<code>API</code>来实现全局注入Store，除了使用默认的<code>Context</code>之外我们也可以使用自定义的<code>Context</code>，看一下默认的实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ReactReduxContext = React.createContext(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ReactReduxContext</span><br></pre></td></tr></table></figure></p>
<p>回到<code>Provider.js</code>，在初始化阶段利用<code>state</code>去存储<code>store</code>及其对应的<code>state</code>信息，在<code>componentDidMount</code>周期调用<code>subscribe</code>方法添加订阅以便于在每次<code>dispatch action</code>的时候可以更新当前<code>state</code>里面的<code>storeState</code>，同时这个方法会返回一个用于取消当前订阅的函数，在<code>componentWillUnmount</code>时候执行。<br>可以看到<code>Provider</code>做的工作其实比较简单，事实上也是如此，主要的工作在<code>connect.js</code>。</p>
<h4 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">'../components/connectAdvanced'</span></span><br><span class="line"><span class="keyword">import</span> shallowEqual <span class="keyword">from</span> <span class="string">'../utils/shallowEqual'</span></span><br><span class="line"><span class="keyword">import</span> defaultMapDispatchToPropsFactories <span class="keyword">from</span> <span class="string">'./mapDispatchToProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultMapStateToPropsFactories <span class="keyword">from</span> <span class="string">'./mapStateToProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultMergePropsFactories <span class="keyword">from</span> <span class="string">'./mergeProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultSelectorFactory <span class="keyword">from</span> <span class="string">'./selectorFactory'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  connect is a facade over connectAdvanced. It turns its args into a compatible</span></span><br><span class="line"><span class="comment">  selectorFactory, which has the signature:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    (dispatch, options) =&gt; (nextState, nextOwnProps) =&gt; nextFinalProps</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  connect passes its args to connectAdvanced as options, which will in turn pass them to</span></span><br><span class="line"><span class="comment">  selectorFactory each time a Connect component instance is instantiated or hot reloaded.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  selectorFactory returns a final props selector from its mapStateToProps,</span></span><br><span class="line"><span class="comment">  mapStateToPropsFactories, mapDispatchToProps, mapDispatchToPropsFactories, mergeProps,</span></span><br><span class="line"><span class="comment">  mergePropsFactories, and pure args.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  The resulting final props selector is called by the Connect component instance whenever</span></span><br><span class="line"><span class="comment">  it receives new props or store state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">arg, factories, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = factories.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = factories[i](arg)</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`Invalid value of type <span class="subst">$&#123;<span class="keyword">typeof</span> arg&#125;</span> for <span class="subst">$&#123;name&#125;</span> argument when connecting component <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        options.wrappedComponentName</span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strictEqual</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a === b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createConnect with default args builds the 'official' connect behavior. Calling it with</span></span><br><span class="line"><span class="comment">// different options opens up some testing and extensibility scenarios</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  connectHOC = connectAdvanced,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories, <span class="regexp">//</span> 根据传入的mapStateToProp参数类型来决定调用什么方法</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories, <span class="regexp">//</span> 根据传入的mapDispatchToProps参数类型来决定调用什么方法</span></span></span><br><span class="line"><span class="function"><span class="params">  mergePropsFactories = defaultMergePropsFactories, <span class="regexp">//</span> 如果不传调用默认的mergeProps方法，否则使用自定义的mergeProps方法</span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory = defaultSelectorFactory <span class="regexp">//</span> 计算mapStateToProps，mapDispatchToProps, ownProps的结果</span></span></span><br><span class="line"><span class="function"><span class="params">&#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      pure = true, <span class="regexp">//</span> 设为true表示我们假设这个组件的状态除了从props传入之外不依赖于外界输入以及自身的state，此时connect只会对相关的state<span class="regexp">/props进行浅比较以避免重新渲染</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      areStatesEqual = strictEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      areOwnPropsEqual = shallowEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      areStatePropsEqual = shallowEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      areMergedPropsEqual = shallowEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      ...extraOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    &#125; = &#123;&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ 根据传入的参数的类型不同Object/</span>Function调用对应的factory方法来返回对应的函数</span></span></span><br><span class="line"><span class="function"><span class="params">    const initMapStateToProps = match(</span></span></span><br><span class="line"><span class="function"><span class="params">      mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">      mapStateToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="string">'mapStateToProps'</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>)</span></span><br><span class="line"><span class="function">    <span class="title">const</span> <span class="title">initMapDispatchToProps</span> = <span class="title">match</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">      mapDispatchToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="string">'mapDispatchToProps'</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>)</span></span><br><span class="line"><span class="function">    <span class="title">const</span> <span class="title">initMergeProps</span> = <span class="title">match</span>(<span class="params">mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">return</span> <span class="title">connectHOC</span>(<span class="params">selectorFactory, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="regexp">//</span> used in error messages</span></span></span><br><span class="line"><span class="function"><span class="params">      methodName: <span class="string">'connect'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="regexp">//</span> used to compute Connect<span class="string">'s displayName from the wrapped component'</span>s displayName.</span></span></span><br><span class="line"><span class="function"><span class="params">      getDisplayName: name =&gt; <span class="string">`Connect(<span class="subst">$&#123;name&#125;</span>)`</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="regexp">//</span> if mapStateToProps is falsy, the Connect component doesn<span class="string">'t subscribe to store state changes</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // 如果没有传mapStateToProps将不会监听state的变化</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      shouldHandleStateChanges: Boolean(mapStateToProps),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // passed through to selectorFactory</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // 传递给selectFactory的参数</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      initMapStateToProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      initMapDispatchToProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      initMergeProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      pure,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      areStatesEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      areOwnPropsEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      areStatePropsEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      areMergedPropsEqual,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // any extra options args can override defaults of connect or connectAdvanced</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      ...extraOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">export default createConnect()</span></span></span></span><br></pre></td></tr></table></figure>
<p>要看懂<code>connect.js</code>需要结合<code>connectAdvanced.js</code>一起，因为后者是前者的基础，这个函数会将<code>React</code>组件和<code>Redux Store</code>链接在一起，但是这个方法不会去处理如何将<code>state</code>、<code>ownProps</code>等组合到<code>props</code>里面，决定其行为的还是<code>connect.js</code>。</p>
<p>通过<code>export default createConnect()</code>可以知道<code>connect.js</code>对外输出的是我们平常使用的<code>connect</code>方法，这个方法接受<code>mapStateToProps</code>、<code>mapDispatchToProps</code>、<code>mergeProps</code>等主要参数以及一些可选参数。</p>
<p>紧接着，通过<code>match</code>方法，根据我们传入的参数类型不同，调用不同的<code>xxfactory</code>方法，以<code>mapStateToProps</code>为例，我们可以选择传入一个函数或者不传，会得到不同的调用结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; wrapMapToPropsConstant, wrapMapToPropsFunc &#125; <span class="keyword">from</span> <span class="string">'./wrapMapToProps'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">whenMapStateToPropsIsFunction</span>(<span class="params">mapStateToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> mapStateToProps === <span class="string">'function'</span></span><br><span class="line">    ? wrapMapToPropsFunc(mapStateToProps, <span class="string">'mapStateToProps'</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">whenMapStateToPropsIsMissing</span>(<span class="params">mapStateToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !mapStateToProps ? wrapMapToPropsConstant(<span class="function"><span class="params">()</span> =&gt;</span> (&#123;&#125;)) : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [whenMapStateToPropsIsFunction, whenMapStateToPropsIsMissing]</span><br></pre></td></tr></table></figure>
<p>如果不传<code>mapStateToProps</code>会调用<code>wrapMapToPropsConstant</code>方法，该方法以一个返回空对象的函数作为参数，最后其实还是返回一个空对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsConstant</span>(<span class="params">getConstant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initConstantSelector</span>(<span class="params">dispatch, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> constant = getConstant(dispatch, options)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">constantSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> constant</span><br><span class="line">    &#125;</span><br><span class="line">    constantSelector.dependsOnOwnProps = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> constantSelector</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>否则的话就调用<code>wrapMapToPropsFunc</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="function"><span class="keyword">function</span> <span class="title">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> proxy.dependsOnOwnProps</span><br><span class="line">        ? proxy.mapToProps(stateOrDispatch, ownProps)</span><br><span class="line">        : proxy.mapToProps(stateOrDispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">    proxy.dependsOnOwnProps = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    proxy.mapToProps = <span class="function"><span class="keyword">function</span> <span class="title">detectFactoryAndVerify</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      stateOrDispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">      ownProps</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">      proxy.mapToProps = mapToProps</span><br><span class="line">      <span class="comment">// 检查是否订阅了ownProps</span></span><br><span class="line">      proxy.dependsOnOwnProps = getDependsOnOwnProps(mapToProps)</span><br><span class="line">      <span class="keyword">let</span> props = proxy(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">'function'</span>) &#123;</span><br><span class="line">        proxy.mapToProps = props</span><br><span class="line">        proxy.dependsOnOwnProps = getDependsOnOwnProps(props)</span><br><span class="line">        props = proxy(stateOrDispatch, ownProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>)</span><br><span class="line">        verifyPlainObject(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> props</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会返回一个名为<code>initProxySelector</code>的接受<code>dispatch</code>作为参数的函数，关于这个函数细节待会回来看，先回到<code>connect.js</code>，接着往下看。</p>
<p>在做完上述工作后，直接将所有参数传入<code>connectHOC</code>，所以我们要看一下<code>connectHOC</code>做了什么：</p>
<h4 id="connectAdvanced"><a href="#connectAdvanced" class="headerlink" title="connectAdvanced"></a>connectAdvanced</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hoistStatics <span class="keyword">from</span> <span class="string">'hoist-non-react-statics'</span></span><br><span class="line"><span class="keyword">import</span> invariant <span class="keyword">from</span> <span class="string">'invariant'</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component, PureComponent &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; isValidElementType, isContextConsumer &#125; <span class="keyword">from</span> <span class="string">'react-is'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ReactReduxContext &#125; <span class="keyword">from</span> <span class="string">'./Context'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stringifyComponent = <span class="function"><span class="params">Comp</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(Comp)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(Comp)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="regexp">/*</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    selectorFactory is a func that is responsible for returning the selector function used to</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    compute new props from state, props, and dispatch. For example:</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      export default connectAdvanced((dispatch, options) =&gt; (state, props) =&gt; (&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        thing: state.things[props.thingId],</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">        saveThing: fields =&gt; dispatch(actionCreators.saveThing(props.thingId, fields)),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">      &#125;))(YourComponent)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Access to dispatch is provided to the factory so selectorFactories can bind actionCreators</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    outside of their selector as an optimization. Options passed to connectAdvanced are passed to</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    the selectorFactory, along with displayName and WrappedComponent, as the second argument.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    Note that selectorFactory is responsible for all caching/m</span>emoization of inbound and outbound</span></span></span><br><span class="line"><span class="function"><span class="params">    props. Do not use connectAdvanced directly without memoizing results between calls to your</span></span></span><br><span class="line"><span class="function"><span class="params">    selector, otherwise the Connect component will re-render on every state or props change.</span></span></span><br><span class="line"><span class="function"><span class="params">  *<span class="regexp">/</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  selectorFactory,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  /</span><span class="regexp">/ options object:</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">  &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ the func used to compute this HOC's displayName from the wrapped component's displayName.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ probably overridden by wrapper functions such as connect()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    getDisplayName = name =&gt; `ConnectAdvanced($&#123;name&#125;)`,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ shown in error messages</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ probably overridden by wrapper functions such as connect()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    methodName = 'connectAdvanced',</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ REMOVED: if defined, the name of the property passed to the wrapped element indicating the number of</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ calls to render. useful for watching in react devtools for unnecessary re-renders.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    renderCountProp = undefined,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ determines whether this HOC subscribes to store changes</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    shouldHandleStateChanges = true,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="regexp">    /</span><span class="regexp">/ REMOVED: the key of props/</span>context to get the store</span></span></span><br><span class="line"><span class="function"><span class="params">    storeKey = <span class="string">'store'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> REMOVED: expose the wrapped component via refs</span></span></span><br><span class="line"><span class="function"><span class="params">    withRef = false,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> use React<span class="string">'s forwardRef to expose a ref of the wrapped component</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    forwardRef = false,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    // the context consumer to use</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    context = ReactReduxContext,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    // additional options are passed through to the selectorFactory</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    ...connectOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  &#125; = &#123;&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    renderCountProp === undefined,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    `renderCountProp is removed. render counting is built into the latest React dev tools profiling extension`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    !withRef,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    '</span>withRef is removed. To access the wrapped instance, use a ref on the connected component<span class="string">'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  const customStoreWarningMessage =</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    '</span>To use a custom Redux store for specific components,  create a custom React context with <span class="string">' +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    "React.createContext(), and pass the context object to React Redux'</span>s Provider and specific components<span class="string">" +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    ' like:  &lt;Provider context=&#123;MyContext&#125;&gt;&lt;ConnectedComponent context=&#123;MyContext&#125; /&gt;&lt;/Provider&gt;. ' +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    'You may also pass a &#123;context : MyContext&#125; option to connect'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    storeKey === 'store',</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    'storeKey has been removed and does not do anything. ' +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      customStoreWarningMessage</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  // 存储context</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  const Context = context</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  return function wrapWithConnect(WrappedComponent) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    if (process.env.NODE_ENV !== 'production') &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        isValidElementType(WrappedComponent),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        `You must pass a component to the function returned by ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          `$&#123;methodName&#125;. Instead received $&#123;stringifyComponent(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          )&#125;`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    const wrappedComponentName =</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      WrappedComponent.displayName || WrappedComponent.name || 'Component'</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    const displayName = getDisplayName(wrappedComponentName)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    const selectorFactoryOptions = &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      ...connectOptions,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      getDisplayName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      methodName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      renderCountProp,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      shouldHandleStateChanges,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      storeKey,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      displayName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      wrappedComponentName,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    const &#123; pure &#125; = connectOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    // pure参数决定是继承Component还是PureComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    let OuterBaseComponent = Component</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    if (pure) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      OuterBaseComponent = PureComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    function makeDerivedPropsSelector() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastState</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastDerivedProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastStore</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastSelectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let sourceSelector</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      return function selectDerivedProps(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        state,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        props,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        store,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        selectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        if (pure &amp;&amp; lastProps === props &amp;&amp; lastState === state) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          // 直接返回上一次生成的props，避免不必要的渲染工作</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          return lastDerivedProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        if (</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          store !== lastStore ||</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastSelectorFactoryOptions !== selectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          // 更新数据</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastStore = store</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastSelectorFactoryOptions = selectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          sourceSelector = selectorFactory(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            store.dispatch,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            selectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        lastProps = props</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        lastState = state</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // 生成新的需要注入的props，这里传入的props是ownProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        const nextProps = sourceSelector(state, props)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        lastDerivedProps = nextProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return lastDerivedProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    function makeChildElementSelector() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      let lastChildProps, lastForwardRef, lastChildElement, lastComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      return function selectChildElement(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        WrappedComponent,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        childProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        forwardRef</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        if (</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          childProps !== lastChildProps ||</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          forwardRef !== lastForwardRef ||</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastComponent !== WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastChildProps = childProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastForwardRef = forwardRef</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastComponent = WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          lastChildElement = (</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            &lt;WrappedComponent &#123;...childProps&#125; ref=&#123;forwardRef&#125; /&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return lastChildElement</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    class Connect extends OuterBaseComponent &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      constructor(props) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        super(props)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          forwardRef ? !props.wrapperProps[storeKey] : !props[storeKey],</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          'Passing redux store in props has been removed and does not do anything. ' +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            customStoreWarningMessage</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        this.selectDerivedProps = makeDerivedPropsSelector()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        this.selectChildElement = makeChildElementSelector()</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        this.indirectRenderWrappedComponent = this.indirectRenderWrappedComponent.bind(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          this</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      indirectRenderWrappedComponent(value) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // calling renderWrappedComponent on prototype from indirectRenderWrappedComponent bound to `this`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return this.renderWrappedComponent(value)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      renderWrappedComponent(value) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // 这里的value就是最开始在Provider里面定义的state</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        invariant(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          value,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          `Could not find "</span>store<span class="string">" in the context of ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            `"</span>$&#123;displayName&#125;<span class="string">". Either wrap the root component in a &lt;Provider&gt;, ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            `or pass a custom React context provider to &lt;Provider&gt; and the corresponding ` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            `React context consumer to $&#123;displayName&#125; in connect options.`</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        const &#123; storeState, store &#125; = value</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        let wrapperProps = this.props</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        let forwardedRef</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        if (forwardRef) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          wrapperProps = this.props.wrapperProps</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          forwardedRef = this.props.forwardedRef</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // 生成要将store中哪些数据注入props的方法</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        let derivedProps = this.selectDerivedProps(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          storeState,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          wrapperProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          store,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          selectorFactoryOptions</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // 拼装最后需要返回给connectAdvanced的组件</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return this.selectChildElement(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          WrappedComponent,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          derivedProps,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          forwardedRef</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      render() &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        // 获取context以便使用context.consumer获取store的变更</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        const ContextToUse =</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          this.props.context &amp;&amp;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          this.props.context.Consumer &amp;&amp;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          isContextConsumer(&lt;this.props.context.Consumer /&gt;)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            ? this.props.context</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            : Context</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return (</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          &lt;ContextToUse.Consumer&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">            &#123;this.indirectRenderWrappedComponent&#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">          &lt;/ContextToUse.Consumer&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        )</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    Connect.WrappedComponent = WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    Connect.displayName = displayName</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    if (forwardRef) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // 将ref转发给子组件</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      const forwarded = React.forwardRef(function forwardConnectRef(</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        props,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        ref</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      ) &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">        return &lt;Connect wrapperProps=&#123;props&#125; forwardedRef=&#123;ref&#125; /&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      &#125;)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      forwarded.displayName = displayName</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      forwarded.WrappedComponent = WrappedComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      // hoistStatics用于copy静态方法，避免在使用HOC的时候类的静态方法丢失</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">      return hoistStatics(forwarded, WrappedComponent)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">    return hoistStatics(Connect, WrappedComponent)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">  &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">&#125;</span></span></span></span><br></pre></td></tr></table></figure>
<p>略过前面的一堆警告判断不看，直接看返回，<code>connectAdvanced</code>会返回一个叫<code>wrapWithConnect</code>的方法，这个方法以一个<code>React Component</code>作为参数，回想我们平常调用<code>connect</code>的时候：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect(mapStateToProps,mapDispatchToProps,mergeProps,options)(App);</span><br></pre></td></tr></table></figure>
<p>就是在这里，这个函数会先获取到<code>wrappedComponentName</code>，然后将除了<code>connect</code>方法前三个参数之外的其他参数都包裹到了<code>selectorFactoryOptions</code>里面，<code>wrapWithConnect</code>这个<code>HOC</code>会返回一个新的组件给我们，至于新组件是继承<code>Component</code>还是<code>PureComponent</code>取决于我们配置的<code>pure</code>参数，这里跳过接下来的两个方法直接看<code>return</code>，因为用到了<code>HOC</code>这里有两个需要注意的问题，一个是<code>ref</code>转发，这里代码里面有相关体现，另一个就是在使用<code>HOC</code>的时候会造成<code>static</code>丢失的问题，这里通过<code>hoist-non-react-statics</code>进行了处理，具体的描述可以看<a href="https://reactjs.org/docs/higher-order-components.html#static-methods-must-be-copied-over" target="_blank" rel="noopener">react doc</a>。</p>
<p><code>render</code>的时候会调用<code>this.indirectRenderWrappedComponent</code>方法，这个方法接收当前的<code>context</code>值，也就是<code>Provider</code>里面提供的<code>state</code>，看一眼这个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">renderWrappedComponent(value) &#123;</span><br><span class="line">        <span class="comment">// 这里的value就是最开始在Provider里面定义的state</span></span><br><span class="line">        invariant(</span><br><span class="line">          value,</span><br><span class="line">          <span class="string">`Could not find "store" in the context of `</span> +</span><br><span class="line">            <span class="string">`"<span class="subst">$&#123;displayName&#125;</span>". Either wrap the root component in a &lt;Provider&gt;, `</span> +</span><br><span class="line">            <span class="string">`or pass a custom React context provider to &lt;Provider&gt; and the corresponding `</span> +</span><br><span class="line">            <span class="string">`React context consumer to <span class="subst">$&#123;displayName&#125;</span> in connect options.`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">const</span> &#123; storeState, store &#125; = value</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> wrapperProps = <span class="keyword">this</span>.props</span><br><span class="line">        <span class="keyword">let</span> forwardedRef</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forwardRef) &#123;</span><br><span class="line">          wrapperProps = <span class="keyword">this</span>.props.wrapperProps</span><br><span class="line">          forwardedRef = <span class="keyword">this</span>.props.forwardedRef</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成要将store中哪些数据注入props的方法</span></span><br><span class="line">        <span class="keyword">let</span> derivedProps = <span class="keyword">this</span>.selectDerivedProps(</span><br><span class="line">          storeState,</span><br><span class="line">          wrapperProps,</span><br><span class="line">          store,</span><br><span class="line">          selectorFactoryOptions</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// 拼装最后需要返回给connectAdvanced的组件</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.selectChildElement(</span><br><span class="line">          WrappedComponent,</span><br><span class="line">          derivedProps,</span><br><span class="line">          forwardedRef</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>前面的不看，直接看<code>selectDerivedProps</code>，其实是调用了<code>makeDerivedPropsSelector</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeDerivedPropsSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> lastProps</span><br><span class="line">      <span class="keyword">let</span> lastState</span><br><span class="line">      <span class="keyword">let</span> lastDerivedProps</span><br><span class="line">      <span class="keyword">let</span> lastStore</span><br><span class="line">      <span class="keyword">let</span> lastSelectorFactoryOptions</span><br><span class="line">      <span class="keyword">let</span> sourceSelector</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">selectDerivedProps</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        state,</span></span></span><br><span class="line"><span class="function"><span class="params">        props,</span></span></span><br><span class="line"><span class="function"><span class="params">        store,</span></span></span><br><span class="line"><span class="function"><span class="params">        selectorFactoryOptions</span></span></span><br><span class="line"><span class="function"><span class="params">      </span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pure &amp;&amp; lastProps === props &amp;&amp; lastState === state) &#123;</span><br><span class="line">          <span class="comment">// 直接返回上一次生成的props，避免不必要的渲染工作</span></span><br><span class="line">          <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          store !== lastStore ||</span><br><span class="line">          lastSelectorFactoryOptions !== selectorFactoryOptions</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// 更新数据</span></span><br><span class="line">          lastStore = store</span><br><span class="line">          lastSelectorFactoryOptions = selectorFactoryOptions</span><br><span class="line">          sourceSelector = selectorFactory(</span><br><span class="line">            store.dispatch,</span><br><span class="line">            selectorFactoryOptions</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastProps = props</span><br><span class="line">        lastState = state</span><br><span class="line">        <span class="comment">// 生成新的需要注入的props，这里传入的props是ownProps</span></span><br><span class="line">        <span class="keyword">const</span> nextProps = sourceSelector(state, props)</span><br><span class="line"></span><br><span class="line">        lastDerivedProps = nextProps</span><br><span class="line">        <span class="keyword">return</span> lastDerivedProps</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先会对<code>state</code>和<code>props</code>做一次浅比较，如果没有变化直接返回上一次计算得到的结果，否则将<code>dispatch</code>和<code>selectorFactoryOptions</code>传入<code>selectorFactory</code>得到<code>sourceSelector</code>，<code>sourceSelector</code>由<code>connect</code>传入，这个方法用于计算<code>mapStateToProps</code>、<code>mapDispatchToProps</code>、 <code>ownProps</code>的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; initMapStateToProps, initMapDispatchToProps, initMergeProps, ...options &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    verifySubselectors(</span><br><span class="line">      mapStateToProps,</span><br><span class="line">      mapDispatchToProps,</span><br><span class="line">      mergeProps,</span><br><span class="line">      options.displayName</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.pure</span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selectorFactory(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>initMapStateToProps</code>之流就是我们之前<code>wrapMapToPropsFunc</code>函数返回的结果，我把代码贴下面方便对照：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="function"><span class="keyword">function</span> <span class="title">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> proxy.dependsOnOwnProps</span><br><span class="line">        ? proxy.mapToProps(stateOrDispatch, ownProps)</span><br><span class="line">        : proxy.mapToProps(stateOrDispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">    proxy.dependsOnOwnProps = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    proxy.mapToProps = <span class="function"><span class="keyword">function</span> <span class="title">detectFactoryAndVerify</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      stateOrDispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">      ownProps</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">      proxy.mapToProps = mapToProps</span><br><span class="line">      <span class="comment">// 检查是否订阅了ownProps</span></span><br><span class="line">      proxy.dependsOnOwnProps = getDependsOnOwnProps(mapToProps)</span><br><span class="line">      <span class="keyword">let</span> props = proxy(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">'function'</span>) &#123;</span><br><span class="line">        proxy.mapToProps = props</span><br><span class="line">        proxy.dependsOnOwnProps = getDependsOnOwnProps(props)</span><br><span class="line">        props = proxy(stateOrDispatch, ownProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>)</span><br><span class="line">        verifyPlainObject(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> props</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是用<code>mapStateToProps</code>为例，先看<code>finalPropsSelectorFactory</code>，如果我们在参数里面设置了<code>pure</code>，就会调用<code>pureFinalPropsSelectorFactory</code>去构造最后的<code>selectorFactory</code>函数，这个函数定义如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; areStatesEqual, areOwnPropsEqual, areStatePropsEqual &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hasRunAtLeastOnce = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> state</span><br><span class="line">  <span class="keyword">let</span> ownProps</span><br><span class="line">  <span class="keyword">let</span> stateProps</span><br><span class="line">  <span class="keyword">let</span> dispatchProps</span><br><span class="line">  <span class="keyword">let</span> mergedProps</span><br><span class="line">  <span class="comment">// 如果是第一次运行执行该方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleFirstCall</span>(<span class="params">firstState, firstOwnProps</span>) </span>&#123;</span><br><span class="line">    state = firstState</span><br><span class="line">    ownProps = firstOwnProps</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line">    dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    hasRunAtLeastOnce = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewPropsAndNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapDispatchToProps.dependsOnOwnProps)</span><br><span class="line">      dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line"></span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewProps</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapStateToProps.dependsOnOwnProps)</span><br><span class="line">      stateProps = mapStateToProps(state, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapDispatchToProps.dependsOnOwnProps)</span><br><span class="line">      dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line"></span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nextStateProps = mapStateToProps(state, ownProps)</span><br><span class="line">    <span class="keyword">const</span> statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps)</span><br><span class="line">    stateProps = nextStateProps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (statePropsChanged)</span><br><span class="line">      mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 处理后续调用</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleSubsequentCalls</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps)</span><br><span class="line">    <span class="keyword">const</span> stateChanged = !areStatesEqual(nextState, state)</span><br><span class="line">    state = nextState</span><br><span class="line">    ownProps = nextOwnProps</span><br><span class="line">    <span class="comment">// 根据props和state的变动情况执行不同的方法，本质上最后都是调用mergedProps合并props</span></span><br><span class="line">    <span class="keyword">if</span> (propsChanged &amp;&amp; stateChanged) <span class="keyword">return</span> handleNewPropsAndNewState()</span><br><span class="line">    <span class="keyword">if</span> (propsChanged) <span class="keyword">return</span> handleNewProps()</span><br><span class="line">    <span class="keyword">if</span> (stateChanged) <span class="keyword">return</span> handleNewState()</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelector</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasRunAtLeastOnce</span><br><span class="line">      ? handleSubsequentCalls(nextState, nextOwnProps)</span><br><span class="line">      : handleFirstCall(nextState, nextOwnProps)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整体流程比较简单，如果是第一次运行，调用<code>handleFirstCall</code>方法，它会根据传入的<code>state</code>和<code>ownProps</code>来返回<code>merge</code>后的<code>props</code>，这个方法里面调用了<code>mapStateToProps(state, ownProps)</code>，等同于调用了<code>mapToPropsProxy(state, ownProps)</code>，然后在判断是<code>mapStateToProps</code>还是<code>mapDispatchToProps</code>来返回处理后的<code>props</code>，后续运行也是一样的，大致的流程都没有什么大的区别，最后可以看一下默认的<code>mergeProps</code>是怎么处理的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defaultMergeProps</span>(<span class="params">stateProps, dispatchProps, ownProps</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 简单的使用展开运算符合并对象</span></span><br><span class="line">  <span class="keyword">return</span> &#123; ...ownProps, ...stateProps, ...dispatchProps &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到就是直接展开，简明易懂。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:lin794653318@gmail.com">李牧羊</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.limuyang.cc/2019/06/19/阅读分析React-Redux源码/">https://www.limuyang.cc/2019/06/19/阅读分析React-Redux源码/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.limuyang.cc" target="_blank">Atlantis</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/javascript/">javascript</a><a class="post-meta__tags" href="/tags/源码阅读/">源码阅读</a><a class="post-meta__tags" href="/tags/react-redux/">react-redux</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://www.tuchuang001.com/images/2018/04/28/_20180428235252.png"><div class="post-qr-code__desc"></div></div></div><nav id="pagination"><div class="next-post pull-right"><a href="/2019/05/09/阅读分析Vue-Router源码/"><span>阅读分析Vue-Router源码</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.limuyang.cc/2019/06/19/阅读分析React-Redux源码/';
  this.page.identifier = '2019/06/19/阅读分析React-Redux源码/';
  this.page.title = '阅读分析React-Redux源码';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'atlantics1013' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://atlantics1013.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By 李牧羊</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>