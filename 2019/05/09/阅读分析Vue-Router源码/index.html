<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="é˜…è¯»åˆ†æVue-Routeræºç "><meta name="keywords" content="javascript,vue-router,æºç é˜…è¯»"><meta name="author" content="æç‰§ç¾Š,lin794653318@gmail.com"><meta name="copyright" content="æç‰§ç¾Š"><title>é˜…è¯»åˆ†æVue-Routeræºç  | Atlantis</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"HJB2USV1FL","apiKey":"fb4cc72114f6ad072b67049aa8e6b5c6","indexName":"Limuyang","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#è·¯ç”±çš„æ¦‚å¿µ"><span class="toc-number">1.</span> <span class="toc-text">è·¯ç”±çš„æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±"><span class="toc-number">2.</span> <span class="toc-text">å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å‰ç«¯è·¯ç”±çš„å‡ºç°"><span class="toc-number">3.</span> <span class="toc-text">å‰ç«¯è·¯ç”±çš„å‡ºç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼"><span class="toc-number">4.</span> <span class="toc-text">å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Vue-Routerçš„å®ç°æ–¹å¼"><span class="toc-number">5.</span> <span class="toc-text">Vue-Routerçš„å®ç°æ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#è·¯ç”±çš„æ³¨å†Œ"><span class="toc-number">5.1.</span> <span class="toc-text">è·¯ç”±çš„æ³¨å†Œ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#è·¯ç”±çš„å®ä¾‹åŒ–"><span class="toc-number">5.2.</span> <span class="toc-text">è·¯ç”±çš„å®ä¾‹åŒ–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#matchçš„å®ç°"><span class="toc-number">5.3.</span> <span class="toc-text">matchçš„å®ç°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#è·¯ç”±çš„è·³è½¬"><span class="toc-number">5.4.</span> <span class="toc-text">è·¯ç”±çš„è·³è½¬</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">6.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.tuchuang001.com/images/2018/04/27/3-15052H1035cF.jpg"></div><div class="author-info__name text-center">æç‰§ç¾Š</div><div class="author-info__description text-center">å¤§æµ·ä¸å†·ç¬‘è¯</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">30</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">49</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://litten.me/" target="_blank">litten</a><a class="author-info-links__name text-center" href="https://developer.mozilla.org/zh-CN/" target="_blank">MDN</a><a class="author-info-links__name text-center" href="http://blog.csdn.net/wei_smile" target="_blank">CSDN</a><a class="author-info-links__name text-center" href="https://cn.vuejs.org/" target="_blank">Vuejs</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/9f814a87gy1g0s6n93k0tj215d0nagzu.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Atlantis</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">ä¸»é¡µ</a><a class="site-page" href="/categories/Android/">ç§»åŠ¨å¼€å‘</a><a class="site-page" href="/categories/Python/">çˆ¬è™«</a><a class="site-page" href="/categories/æ—§äº‹/">æ—§äº‹</a><a class="site-page" href="/categories/å‰ç«¯å¼€å‘/">å‰ç«¯å¼€å‘</a></span></div><div id="post-info"><div id="post-title">é˜…è¯»åˆ†æVue-Routeræºç </div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/å‰ç«¯å¼€å‘/">å‰ç«¯å¼€å‘</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /"></span></a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">11,041</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 52 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h4 id="è·¯ç”±çš„æ¦‚å¿µ"><a href="#è·¯ç”±çš„æ¦‚å¿µ" class="headerlink" title="è·¯ç”±çš„æ¦‚å¿µ"></a>è·¯ç”±çš„æ¦‚å¿µ</h4><p>è·¯ç”±è¿™ä¸ªæ¦‚å¿µæœ€å¼€å§‹æ˜¯åœ¨åç«¯å‡ºç°çš„ï¼Œä»¥å‰ä½¿ç”¨æ¨¡æ¿å¼•æ“å¼€å‘é¡µé¢çš„æ—¶å€™ç»å¸¸ä¼šçœ‹åˆ°è¿™æ ·çš„è·¯å¾„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://hometown.xxx.edu.cn/bbs/forum.php</span><br></pre></td></tr></table></figure></p>
<p>æœ‰æ—¶è¿˜ä¼šæœ‰å¸¦.aspæˆ–.htmlçš„è·¯å¾„ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„SSR(Server Side Render)ï¼Œé€šè¿‡æœåŠ¡ç«¯æ¸²æŸ“ï¼Œç›´æ¥è¿”å›é¡µé¢ã€‚<br><a id="more"></a><br>å…¶å“åº”è¿‡ç¨‹æ˜¯è¿™æ ·çš„</p>
<p>1.æµè§ˆå™¨å‘å‡ºè¯·æ±‚</p>
<p>2.æœåŠ¡å™¨ç›‘å¬åˆ°80ç«¯å£ï¼ˆæˆ–443ï¼‰æœ‰è¯·æ±‚è¿‡æ¥ï¼Œå¹¶è§£æurlè·¯å¾„</p>
<p>3.æ ¹æ®æœåŠ¡å™¨çš„è·¯ç”±é…ç½®ï¼Œè¿”å›ç›¸åº”ä¿¡æ¯ï¼ˆå¯ä»¥æ˜¯ html å­—ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ json æ•°æ®ï¼Œå›¾ç‰‡ç­‰ï¼‰</p>
<p>4.æµè§ˆå™¨æ ¹æ®æ•°æ®åŒ…çš„Content-Typeæ¥å†³å®šå¦‚ä½•è§£ææ•°æ®</p>
<p>ç®€å•æ¥è¯´è·¯ç”±å°±æ˜¯ç”¨æ¥è·Ÿåç«¯æœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡ä¸åŒçš„è·¯å¾„ï¼Œæ¥è¯·æ±‚ä¸åŒçš„èµ„æºï¼Œè¯·æ±‚ä¸åŒçš„é¡µé¢æ˜¯è·¯ç”±çš„å…¶ä¸­ä¸€ç§åŠŸèƒ½ã€‚å°±åƒè·¯ç”±å™¨åœ¨ç½‘ç»œå±‚ä¸­æ‰®æ¼”çš„è§’è‰²ä¸€æ ·ï¼Œè‚©è´Ÿç€å°†æ•°æ®åŒ…æ­£ç¡®å¯¼å‘ç›®çš„åœ°å€çš„é‡ä»»ï¼Œåªä¸è¿‡åœ¨è¿™é‡Œå˜æˆäº†å®¢æˆ·ç«¯æµè§ˆå™¨çš„æŒ‡è·¯äººï¼Œæ‰€è°“çš„å‰ç«¯è·¯ç”±ï¼ŒæŒ‡çš„æ˜¯ä¸€ç§èƒ½åŠ›ï¼Œå³ï¼š</p>
<blockquote>
<p>ä¸ä¾èµ–äºæœåŠ¡å™¨ï¼Œæ ¹æ®ä¸åŒçš„URLæ¸²æŸ“ä¸åŒçš„é¡µé¢</p>
</blockquote>
<h4 id="å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±"><a href="#å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±" class="headerlink" title="å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±"></a>å‰ç«¯è·¯ç”±ä¸åç«¯è·¯ç”±</h4><p>åœ¨<code>Ajax</code>è¿˜æ²¡æœ‰è¯ç”Ÿçš„æ—¶å€™ï¼Œè·¯ç”±çš„å·¥ä½œæ˜¯äº¤ç»™åç«¯æ¥å®Œæˆçš„ï¼Œå½“è¿›è¡Œé¡µé¢åˆ‡æ¢çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šå‘é€ä¸åŒçš„<code>URL</code>è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°æµè§ˆå™¨çš„è¯·æ±‚æ—¶ï¼Œé€šè¿‡è§£æä¸åŒçš„<code>URL</code>å»æ‹¼æ¥éœ€è¦çš„<code>Html</code>æˆ–æ¨¡æ¿ï¼Œç„¶åå°†ç»“æœè¿”å›åˆ°æµè§ˆå™¨ç«¯è¿›è¡Œæ¸²æŸ“ã€‚</p>
<p>æœåŠ¡å™¨ç«¯è·¯ç”±åŒæ ·æ˜¯æœ‰åˆ©äº¦æœ‰å¼Šã€‚å®ƒçš„å¥½å¤„æ˜¯å®‰å…¨æ€§æ›´é«˜ï¼Œæ›´ä¸¥æ ¼å¾—æ§åˆ¶é¡µé¢çš„å±•ç°ã€‚è¿™åœ¨æŸäº›åœºæ™¯ä¸­æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œè­¬å¦‚ä¸‹å•æ”¯ä»˜æµç¨‹ï¼Œæ¯ä¸€æ­¥åªæœ‰åœ¨ä¸Šä¸€æ­¥æˆåŠŸæ‰§è¡Œä¹‹åæ‰èƒ½æŠµè¾¾ã€‚è¿™åœ¨æœåŠ¡å™¨ç«¯å¯ä»¥ä¸ºæ¯ä¸€æ­¥æµç¨‹æ·»åŠ éªŒè¯æœºåˆ¶ï¼Œåªæœ‰éªŒè¯é€šè¿‡æ‰è¿”å›æ­£ç¡®çš„é¡µé¢ã€‚é‚£ä¹ˆå‰ç«¯è·¯ç”±ä¸èƒ½å®ç°æ¯ä¸€æ­¥çš„éªŒè¯ï¼Ÿè‡ªç„¶ä¸æ˜¯ï¼Œå§‘ä¸”ç›¸ä¿¡ä½ çš„ä»£ç å¯ä»¥å†™çš„å¾ˆä¸¥è°¨ï¼Œä¿è¯æ­£å¸¸æƒ…å†µä¸‹æµç¨‹ä¸ä¼šé”™ï¼Œä½†æ˜¯å¦ä¸€ä¸ªä¸å¾—ä¸é¢å¯¹çš„äº‹å®æ˜¯ï¼šå‰ç«¯æ˜¯æ¯«æ— å®‰å…¨æ€§å¯è¨€çš„ã€‚ç”¨æˆ·å¯ä»¥è‚†æ„ä¿®æ”¹ä»£ç æ¥è¿›å…¥ä¸åŒçš„æµç¨‹ï¼Œä½ å¯èƒ½ä¼šä¸ºæ­¤æ·»åŠ ä¸å°‘çš„å¤„ç†é€»è¾‘ã€‚ç›¸è¾ƒä¹‹ä¸‹ï¼Œå½“ç„¶æ˜¯åç«¯æ§åˆ¶é¡µé¢çš„è¿›å…¥æƒé™æ›´ä¸ºå®‰å…¨å’Œç®€ä¾¿ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œåç«¯è·¯ç”±æ— ç–‘å¢åŠ äº†æœåŠ¡å™¨ç«¯çš„è´Ÿè·ï¼Œå¹¶ä¸”éœ€è¦reloadé¡µé¢ï¼Œç”¨æˆ·ä½“éªŒå…¶å®ä¸ä½³ã€‚</p>
<h4 id="å‰ç«¯è·¯ç”±çš„å‡ºç°"><a href="#å‰ç«¯è·¯ç”±çš„å‡ºç°" class="headerlink" title="å‰ç«¯è·¯ç”±çš„å‡ºç°"></a>å‰ç«¯è·¯ç”±çš„å‡ºç°</h4><p>åœ¨ 90s å¹´ä»£åˆï¼Œå¤§å¤šæ•°çš„ç½‘é¡µéƒ½æ˜¯é€šè¿‡ç›´æ¥è¿”å›<code>HTML</code>çš„ï¼Œç”¨æˆ·çš„æ¯æ¬¡æ›´æ–°æ“ä½œéƒ½éœ€è¦é‡æ–°åˆ·æ–°é¡µé¢ã€‚åŠå…¶å½±å“äº¤äº’ä½“éªŒï¼Œéšç€ç½‘ç»œçš„å‘å±•ï¼Œè¿«åˆ‡éœ€è¦ä¸€ç§æ–¹æ¡ˆæ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚</p>
<p>1996ï¼Œå¾®è½¯é¦–å…ˆæå‡º iframe æ ‡ç­¾ï¼Œ<code>iframe</code>å¸¦æ¥äº†å¼‚æ­¥åŠ è½½å’Œè¯·æ±‚å…ƒç´ çš„æ¦‚å¿µï¼Œéšååœ¨ 1998 å¹´ï¼Œå¾®è½¯çš„ Outloook Web App å›¢é˜Ÿæå‡º<code>Ajax</code>çš„åŸºæœ¬æ¦‚å¿µï¼ˆXMLHttpRequestçš„å‰èº«ï¼‰ï¼Œå¹¶åœ¨<code>IE5</code>é€šè¿‡<code>ActiveX</code>æ¥å®ç°äº†è¿™é¡¹æŠ€æœ¯ã€‚åœ¨å¾®è½¯å®ç°è¿™ä¸ªæ¦‚å¿µåï¼Œå…¶ä»–æµè§ˆå™¨æ¯”å¦‚<code>Mozilia</code>ï¼Œ<code>Safari</code>ï¼Œ<code>Opera</code>ç›¸ç»§ä»¥ <code>XMLHttpRequest</code>æ¥å®ç°<code>Ajax</code>ã€‚ï¼ˆğŸ˜­ å…¼å®¹é—®é¢˜ä»æ­¤å‡ºç°ï¼Œè¯è¯´å¾®è½¯å‘½åçœŸå–œæ¬¢ç”¨Xï¼ŒMFCæºç ä¸€å¤§å †ã€‚ã€‚ï¼‰ä¸è¿‡åœ¨ IE7 å‘å¸ƒæ—¶ï¼Œå¾®è½¯é€‰æ‹©äº†å¦¥åï¼Œå…¼å®¹äº†<code>XMLHttpRequest</code>çš„å®ç°ã€‚</p>
<p>æœ‰äº†<code>Ajax</code>åï¼Œç”¨æˆ·äº¤äº’å°±ä¸ç”¨æ¯æ¬¡éƒ½åˆ·æ–°é¡µé¢ï¼Œä½“éªŒå¸¦æ¥äº†æå¤§çš„æå‡ã€‚</p>
<p>ä½†çœŸæ­£è®©è¿™é¡¹æŠ€æœ¯å‘æ‰¬å…‰å¤§çš„ï¼Œ(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾è¿˜æ˜¯åæ¥çš„ Google Mapï¼Œå®ƒçš„å‡ºç°å‘äººä»¬å±•ç°äº†<code>Ajax</code>çš„çœŸæ­£é­…åŠ›ï¼Œé‡Šæ”¾äº†ä¼—å¤šå¼€å‘äººå‘˜çš„æƒ³è±¡åŠ›ï¼Œè®©å…¶ä¸ä»…ä»…å±€é™äºç®€å•çš„æ•°æ®å’Œé¡µé¢äº¤äº’ï¼Œä¸ºåæ¥å¼‚æ­¥äº¤äº’ä½“éªŒæ–¹å¼çš„ç¹è£å‘å±•å¸¦æ¥äº†æ ¹åŸºã€‚</p>
<p>è€Œå¼‚æ­¥äº¤äº’ä½“éªŒçš„æ›´é«˜çº§ç‰ˆæœ¬å°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„<code>SPA</code>ï¼Œ<code>SPA</code>ä¸å•å•åœ¨é¡µé¢äº¤äº’ä¸Šåšåˆ°äº†ä¸åˆ·æ–°ï¼Œè€Œä¸”åœ¨é¡µé¢ä¹‹é—´è·³è½¬ä¹Ÿåšåˆ°äº†ä¸åˆ·æ–°ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±ä¿ƒä½¿äº†å‰ç«¯è·¯ç”±çš„è¯ç”Ÿã€‚</p>
<h4 id="å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼"><a href="#å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼" class="headerlink" title="å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼"></a>å‰ç«¯è·¯ç”±çš„å®ç°æ–¹å¼</h4><p>å‰ç«¯è·¯ç”±å…¶å®åªè¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>åœ¨é¡µé¢ä¸åˆ·æ–°çš„å‰æä¸‹å®ç°urlå˜åŒ–</li>
<li>æ•æ‰åˆ°urlçš„å˜åŒ–ï¼Œä»¥ä¾¿æ‰§è¡Œé¡µé¢æ›¿æ¢é€»è¾‘<br>åœ¨ 2014 å¹´ä¹‹å‰ï¼Œå¤§å®¶æ˜¯é€šè¿‡ hash æ¥å®ç°è·¯ç”±ï¼Œurl hash å°±æ˜¯ç±»ä¼¼äºï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/#/login</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è¿™ç§ #ã€‚åé¢<code>hash</code>å€¼çš„å˜åŒ–ï¼Œå¹¶ä¸ä¼šå¯¼è‡´æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œæµè§ˆå™¨ä¸å‘å‡ºè¯·æ±‚ï¼Œä¹Ÿå°±ä¸ä¼šåˆ·æ–°é¡µé¢ã€‚å¦å¤–æ¯æ¬¡<code>hash</code>å€¼çš„å˜åŒ–ï¼Œè¿˜ä¼šè§¦å‘<code>hashchange</code>è¿™ä¸ªäº‹ä»¶ï¼Œé€šè¿‡è¿™ä¸ªäº‹ä»¶æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“<code>hash</code>å€¼å‘ç”Ÿäº†å“ªäº›å˜åŒ–ã€‚ç„¶åæˆ‘ä»¬ä¾¿å¯ä»¥ç›‘å¬<code>hashchange</code>æ¥å®ç°æ›´æ–°é¡µé¢éƒ¨åˆ†å†…å®¹çš„æ“ä½œï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchAndUpdate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// todo åŒ¹é… hash åš dom æ›´æ–°æ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'hashchange'</span>, matchAndUpdate)</span><br></pre></td></tr></table></figure>
<p>åæ¥ï¼Œå› ä¸º<code>HTML5</code>æ ‡å‡†å‘å¸ƒã€‚å¤šäº†ä¸¤ä¸ª APIï¼Œ<code>pushState</code>å’Œ<code>replaceState</code>ï¼Œé€šè¿‡è¿™ä¸¤ä¸ª<code>API</code>å¯ä»¥æ”¹å˜ <code>url</code>åœ°å€ä¸”ä¸ä¼šå‘é€è¯·æ±‚ã€‚åŒæ—¶è¿˜æœ‰<code>popstate</code>äº‹ä»¶ã€‚é€šè¿‡è¿™äº›å°±èƒ½ç”¨å¦ä¸€ç§æ–¹å¼æ¥å®ç°å‰ç«¯è·¯ç”±äº†ï¼Œä½†åŸç†éƒ½æ˜¯è·Ÿ<code>hash</code>å®ç°ç›¸åŒçš„ã€‚ç”¨äº†<code>HTML5</code>çš„å®ç°ï¼Œå•é¡µè·¯ç”±çš„<code>url</code>å°±ä¸ä¼šå¤šå‡ºä¸€ä¸ª#ï¼Œå˜å¾—æ›´åŠ ç¾è§‚ã€‚ä½†å› ä¸ºæ²¡æœ‰ # å·ï¼Œæ‰€ä»¥å½“ç”¨æˆ·åˆ·æ–°é¡µé¢ä¹‹ç±»çš„æ“ä½œæ—¶ï¼Œæµè§ˆå™¨è¿˜æ˜¯ä¼šç»™æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚ä¸ºäº†é¿å…å‡ºç°è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥è¿™ä¸ªå®ç°éœ€è¦æœåŠ¡å™¨çš„æ”¯æŒï¼Œéœ€è¦æŠŠæ‰€æœ‰è·¯ç”±éƒ½é‡å®šå‘åˆ°æ ¹é¡µé¢ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchAndUpdate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// todo åŒ¹é…è·¯å¾„ åš dom æ›´æ–°æ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'popstate'</span>, matchAndUpdate)</span><br></pre></td></tr></table></figure>
<h4 id="Vue-Routerçš„å®ç°æ–¹å¼"><a href="#Vue-Routerçš„å®ç°æ–¹å¼" class="headerlink" title="Vue-Routerçš„å®ç°æ–¹å¼"></a>Vue-Routerçš„å®ç°æ–¹å¼</h4><p><code>Vue-Router</code>è·Ÿ<code>Vuex</code>ä¸€æ ·éƒ½æ˜¯é€šè¿‡<code>Vue.use</code>è¿™ä¸ªå…¨å±€<code>API</code>æ¥æ³¨å†Œçš„ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨<code>vue/src/core/global-api/use.js</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; toArray &#125; <span class="keyword">from</span> <span class="string">'../util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initUse</span> (<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  Vue.use = <span class="function"><span class="keyword">function</span> (<span class="params">plugin: Function | Object</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> installedPlugins = (<span class="keyword">this</span>._installedPlugins || (<span class="keyword">this</span>._installedPlugins = []))</span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.indexOf(plugin) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additional parameters</span></span><br><span class="line">    <span class="keyword">const</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>)</span><br><span class="line">    args.unshift(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.install === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.install.apply(plugin, args)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.apply(<span class="literal">null</span>, args)</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.push(plugin)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Vue.use</code>æ¥å—ä¸€ä¸ª<code>plugin</code>å‚æ•°ï¼Œå¹¶ä¸”ç»´æŠ¤äº†ä¸€ä¸ª<code>_installedPlugins</code>æ•°ç»„ï¼Œå®ƒå­˜å‚¨æ‰€æœ‰æ³¨å†Œè¿‡çš„<code>plugin</code>ï¼›å¦‚æœ<code>plugin</code>æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¼šåˆ¤æ–­<code>plugin</code>æœ‰æ²¡æœ‰å®šä¹‰<code>install</code>æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯åˆ™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>Vue</code>ï¼›å¦‚æœ<code>plugin</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šè¢«ä½œä¸º<code>install</code>æ–¹æ³•ï¼Œæœ€åæŠŠ<code>plugin</code>å­˜å‚¨åˆ°<code>installedPlugins</code>æ•°ç»„é‡Œé¢ï¼Œ<code>Vue</code>çš„è¿™ç§æ’ä»¶æ³¨å†Œçš„æœºåˆ¶æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦é¢å¤–çš„å»<code>import Vue</code>äº†ã€‚</p>
<h5 id="è·¯ç”±çš„æ³¨å†Œ"><a href="#è·¯ç”±çš„æ³¨å†Œ" class="headerlink" title="è·¯ç”±çš„æ³¨å†Œ"></a>è·¯ç”±çš„æ³¨å†Œ</h5><p><code>Vue-Router</code>çš„å…¥å£åœ¨<code>src/index.js</code>ï¼Œå…¶ä¸­<code>install</code>æ–¹æ³•å®šä¹‰åœ¨<code>src/install.js</code>ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹<code>src</code>ä¸‹é¢çš„ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ components</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ link.js</span><br><span class="line">â”‚Â Â  â””â”€â”€ view.js</span><br><span class="line">â”œâ”€â”€ create-matcher.js</span><br><span class="line">â”œâ”€â”€ create-route-map.js</span><br><span class="line">â”œâ”€â”€ history</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ abstract.js</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ base.js</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ hash.js</span><br><span class="line">â”‚Â Â  â””â”€â”€ html5.js</span><br><span class="line">â”œâ”€â”€ index.js</span><br><span class="line">â”œâ”€â”€ install.js</span><br><span class="line">â””â”€â”€ util</span><br><span class="line">    â”œâ”€â”€ async.js</span><br><span class="line">    â”œâ”€â”€ dom.js</span><br><span class="line">    â”œâ”€â”€ location.js</span><br><span class="line">    â”œâ”€â”€ misc.js</span><br><span class="line">    â”œâ”€â”€ params.js</span><br><span class="line">    â”œâ”€â”€ path.js</span><br><span class="line">    â”œâ”€â”€ push-state.js</span><br><span class="line">    â”œâ”€â”€ query.js</span><br><span class="line">    â”œâ”€â”€ resolve-components.js</span><br><span class="line">    â”œâ”€â”€ route.js</span><br><span class="line">    â”œâ”€â”€ scroll.js</span><br><span class="line">    â””â”€â”€ warn.js</span><br></pre></td></tr></table></figure>
<p>ç®€å•çœ‹ä¸‹<code>install</code>çš„æµç¨‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> View <span class="keyword">from</span> <span class="string">'./components/view'</span></span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">'./components/link'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> _Vue</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">install</span> (<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç¡®ä¿Vue-Routeråªè¢«installä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">if</span> (install.installed &amp;&amp; _Vue === Vue) <span class="keyword">return</span></span><br><span class="line">  install.installed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  _Vue = Vue</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isDef = <span class="function"><span class="params">v</span> =&gt;</span> v !== <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> registerInstance = <span class="function">(<span class="params">vm, callVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> i = vm.$options._parentVnode</span><br><span class="line">    <span class="keyword">if</span> (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</span><br><span class="line">      i(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    <span class="comment">// åœ¨beforeCreateé’©å­é‡Œé¢åˆå§‹åŒ–è·¯ç”±</span></span><br><span class="line">    beforeCreate () &#123;</span><br><span class="line">      <span class="comment">// æ ¹ç»„ä»¶çš„$optionsä¸Šæ‰æœ‰routerå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(<span class="keyword">this</span>.$options.router)) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ ¹è·¯ç”±</span></span><br><span class="line">        <span class="keyword">this</span>._routerRoot = <span class="keyword">this</span></span><br><span class="line">        <span class="comment">// è·å–åˆ°æ ¹ç»„ä»¶ä¸Šçš„routerå®ä¾‹</span></span><br><span class="line">        <span class="keyword">this</span>._router = <span class="keyword">this</span>.$options.router</span><br><span class="line">        <span class="comment">// è·¯ç”±åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">this</span>._router.init(<span class="keyword">this</span>)</span><br><span class="line">        <span class="comment">// ä¸º_routeå±æ€§å®ç°åŒå‘ç»‘å®š</span></span><br><span class="line">        Vue.util.defineReactive(<span class="keyword">this</span>, <span class="string">'_route'</span>, <span class="keyword">this</span>._router.history.current)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çˆ¶ç»„ä»¶çš„_routerRoot</span></span><br><span class="line">        <span class="keyword">this</span>._routerRoot = (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$parent._routerRoot) || <span class="keyword">this</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ³¨å†Œ&lt;router-view&gt;&lt;/router-view&gt;å®ä¾‹çš„é’©å­</span></span><br><span class="line">      registerInstance(<span class="keyword">this</span>, <span class="keyword">this</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed () &#123;</span><br><span class="line">      registerInstance(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// æ–¹ä¾¿å…¨å±€é€šè¿‡this.$routerè·å–è·¯ç”±å®ä¾‹</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$router'</span>, &#123;</span><br><span class="line">    <span class="keyword">get</span> () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._router &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// æ–¹ä¾¿å…¨å±€é€šè¿‡this.$routeè·å–è·¯ç”±å¯¹è±¡</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$route'</span>, &#123;</span><br><span class="line">    <span class="keyword">get</span> () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._route &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// æ³¨å†Œå…¨å±€ç»„ä»¶&lt;router-view/&gt;å’Œ&lt;router-link/&gt;</span></span><br><span class="line">  Vue.component(<span class="string">'RouterView'</span>, View)</span><br><span class="line">  Vue.component(<span class="string">'RouterLink'</span>, Link)</span><br><span class="line">  <span class="comment">// ä½¿ç”¨å’Œcreatedç›¸åŒçš„åˆå¹¶ç­–ç•¥</span></span><br><span class="line">  <span class="keyword">const</span> strats = Vue.config.optionMergeStrategies</span><br><span class="line">  <span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">  strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆé€šè¿‡è®¾ç«‹ä¸€ä¸ª<code>installed</code>æ ‡å¿—ä½æ¥ç¡®ä¿<code>Vue-Router</code>åªè¢«å®‰è£…ä¸€æ¬¡ï¼Œç„¶åé€šè¿‡å˜é‡<code>_Vue</code>æ‰¿è½½ä¼ å…¥çš„<code>Vue</code>å®ä¾‹ï¼Œç„¶ååˆ©ç”¨<code>Vue.mixin</code>å‘æ¯ä¸€ä¸ª<code>Vue</code>å®ä¾‹æ³¨å†Œ<code>beforeCreate</code>å’Œ<code>destroyed</code>é’©å­å‡½æ•°ã€‚</p>
<p>åœ¨<code>beforeCreate</code>å‡½æ•°é‡Œé¢ï¼Œå¦‚æœæ˜¯æ ¹ç»„ä»¶ï¼Œå°†æ ¹ç»„ä»¶èµ‹å€¼ç»™<code>this._routerRoot</code>ï¼Œè·å–æ ¹ç»„ä»¶çš„è·¯ç”±å®ä¾‹ä¹‹åæ‰§è¡Œ<code>init</code>åˆå§‹åŒ–å‡½æ•°ï¼Œç„¶åè°ƒç”¨<code>Vue</code>çš„<code>defineReactive</code>å°†<code>_route</code>å˜ä¸ºå“åº”å¼å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯æ ¹ç»„ä»¶åˆ™è·å–çˆ¶ç»„ä»¶çš„<code>_routerRoot</code>å±æ€§ã€‚</p>
<p>åœ¨<code>beforeCreate</code>å‡½æ•°çš„æœ€åéƒ¨åˆ†å’Œ<code>destroyed</code>å‡½æ•°é‡Œé¢éƒ½æ‰§è¡Œäº†<code>registerInstance</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æ³¨å†Œ<code>&lt;router-view&gt;</code>å®ä¾‹çš„é’©å­å‡½æ•°ï¼Œæ ¹æ®ä¼ å…¥å‚æ•°çš„ä¸ªæ•°æ¥å†³å®šæ˜¯æ³¨å†Œè¿˜æ˜¯å–æ¶ˆæ³¨å†Œï¼Œå‡½æ•°çš„å®šä¹‰åœ¨<code>src/components/view.js</code>é‡Œé¢:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attach instance registration hook</span></span><br><span class="line"> <span class="comment">// this will be called in the instance's injected lifecycle hooks</span></span><br><span class="line"> data.registerRouteInstance = <span class="function">(<span class="params">vm, val</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// val could be undefined for unregistration</span></span><br><span class="line">   <span class="keyword">const</span> current = matched.instances[name]</span><br><span class="line">   <span class="keyword">if</span> (</span><br><span class="line">     (val &amp;&amp; current !== vm) ||</span><br><span class="line">     (!val &amp;&amp; current === vm)</span><br><span class="line">   ) &#123;</span><br><span class="line">     matched.instances[name] = val</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>å›åˆ°<code>install.js</code>ï¼Œç´§æ¥ç€ï¼Œä¸ºäº†è®©æˆ‘ä»¬èƒ½å¤Ÿå…¨å±€çš„ä½¿ç”¨<code>this.$router</code>å’Œ<code>this.$route</code>åœ¨<code>Vue</code>åŸå‹ä¸Šå®šä¹‰äº†å¯¹åº”çš„<code>get</code>æ–¹æ³•ï¼Œç„¶åé€šè¿‡<code>Vue.component</code>æ³¨å†Œäº†å…¨å±€ç»„ä»¶<code>æ³¨å†Œå…¨å±€ç»„ä»¶&lt;router-view/&gt;</code>å’Œ<code>å’Œ&lt;router-link/&gt;</code>ï¼Œæœ€åå®šä¹‰äº†ä¸€äº›é’©å­å‡½æ•°çš„ä½¿ç”¨ç­–ç•¥ï¼Œè¿™å°±æ˜¯æ•´ä¸ª<code>Vue-Router</code>çš„å®‰è£…è¿‡ç¨‹ã€‚</p>
<h5 id="è·¯ç”±çš„å®ä¾‹åŒ–"><a href="#è·¯ç”±çš„å®ä¾‹åŒ–" class="headerlink" title="è·¯ç”±çš„å®ä¾‹åŒ–"></a>è·¯ç”±çš„å®ä¾‹åŒ–</h5><p>å…ˆçœ‹ä¸€ä¸‹<code>Vue-Router</code>çš„æ„é€ å‡½æ•°ï¼Œå½“æˆ‘ä»¬<code>new</code>ä¸€ä¸ª<code>Vue-Router</code>çš„æ—¶å€™éƒ½å¹²äº†äº›ä»€ä¹ˆï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; install &#125; <span class="keyword">from</span> <span class="string">'./install'</span></span><br><span class="line"><span class="keyword">import</span> &#123; START &#125; <span class="keyword">from</span> <span class="string">'./util/route'</span></span><br><span class="line"><span class="keyword">import</span> &#123; assert &#125; <span class="keyword">from</span> <span class="string">'./util/warn'</span></span><br><span class="line"><span class="keyword">import</span> &#123; inBrowser &#125; <span class="keyword">from</span> <span class="string">'./util/dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; cleanPath &#125; <span class="keyword">from</span> <span class="string">'./util/path'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createMatcher &#125; <span class="keyword">from</span> <span class="string">'./create-matcher'</span></span><br><span class="line"><span class="keyword">import</span> &#123; normalizeLocation &#125; <span class="keyword">from</span> <span class="string">'./util/location'</span></span><br><span class="line"><span class="keyword">import</span> &#123; supportsPushState &#125; <span class="keyword">from</span> <span class="string">'./util/push-state'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HashHistory &#125; <span class="keyword">from</span> <span class="string">'./history/hash'</span></span><br><span class="line"><span class="keyword">import</span> &#123; HTML5History &#125; <span class="keyword">from</span> <span class="string">'./history/html5'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AbstractHistory &#125; <span class="keyword">from</span> <span class="string">'./history/abstract'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> type &#123; Matcher &#125; <span class="keyword">from</span> <span class="string">'./create-matcher'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> install: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  <span class="keyword">static</span> version: string;</span><br><span class="line">  app: any;</span><br><span class="line">  apps: <span class="built_in">Array</span>&lt;any&gt;;</span><br><span class="line">  ready: boolean;</span><br><span class="line">  readyCbs: <span class="built_in">Array</span>&lt;<span class="built_in">Function</span>&gt;;</span><br><span class="line">  options: RouterOptions;</span><br><span class="line">  mode: string;</span><br><span class="line">  history: HashHistory | HTML5History | AbstractHistory;</span><br><span class="line">  matcher: Matcher;</span><br><span class="line">  fallback: boolean;</span><br><span class="line">  beforeHooks: <span class="built_in">Array</span>&lt;?NavigationGuard&gt;;</span><br><span class="line">  resolveHooks: <span class="built_in">Array</span>&lt;?NavigationGuard&gt;;</span><br><span class="line">  afterHooks: <span class="built_in">Array</span>&lt;?AfterNavigationHook&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (options: RouterOptions = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// æ ¹Vueå®ä¾‹</span></span><br><span class="line">    <span class="keyword">this</span>.app = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// å­˜å‚¨å«æœ‰this.$options.routerå±æ€§çš„Vueå®ä¾‹</span></span><br><span class="line">    <span class="keyword">this</span>.apps = []</span><br><span class="line">    <span class="comment">// ä¼ å…¥è·¯ç”±çš„é…ç½®</span></span><br><span class="line">    <span class="keyword">this</span>.options = options</span><br><span class="line">    <span class="keyword">this</span>.beforeHooks = []</span><br><span class="line">    <span class="keyword">this</span>.resolveHooks = []</span><br><span class="line">    <span class="keyword">this</span>.afterHooks = []</span><br><span class="line">    <span class="comment">// åˆ›å»ºè·¯ç”±åŒ¹é…å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">this</span>.matcher = createMatcher(options.routes || [], <span class="keyword">this</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸ºhashæ¨¡å¼</span></span><br><span class="line">    <span class="keyword">let</span> mode = options.mode || <span class="string">'hash'</span></span><br><span class="line">    <span class="comment">// å½“æµè§ˆå™¨ä¸æ”¯æŒ history.pushState æ§åˆ¶è·¯ç”±æ˜¯å¦åº”è¯¥å›é€€åˆ° hash æ¨¡å¼ã€‚é»˜è®¤å€¼ä¸º true</span></span><br><span class="line">    <span class="keyword">this</span>.fallback = mode === <span class="string">'history'</span> &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fallback) &#123;</span><br><span class="line">      mode = <span class="string">'hash'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ”¯æŒæ‰€æœ‰ JavaScript è¿è¡Œç¯å¢ƒï¼Œå¦‚ Node.js æœåŠ¡å™¨ç«¯ã€‚å¦‚æœå‘ç°æ²¡æœ‰æµè§ˆå™¨çš„ APIï¼Œè·¯ç”±ä¼šè‡ªåŠ¨å¼ºåˆ¶è¿›å…¥è¿™ä¸ªæ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (!inBrowser) &#123;</span><br><span class="line">      mode = <span class="string">'abstract'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.mode = mode</span><br><span class="line">    <span class="comment">// æ ¹æ®modeé‡‡ç”¨ä¸åŒçš„è·¯ç”±æ–¹å¼</span></span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'history'</span>:</span><br><span class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> HTML5History(<span class="keyword">this</span>, options.base)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'hash'</span>:</span><br><span class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> HashHistory(<span class="keyword">this</span>, options.base, <span class="keyword">this</span>.fallback)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'abstract'</span>:</span><br><span class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> AbstractHistory(<span class="keyword">this</span>, options.base)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">          assert(<span class="literal">false</span>, <span class="string">`invalid mode: <span class="subst">$&#123;mode&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  match (</span><br><span class="line">    raw: RawLocation,</span><br><span class="line">    current?: Route,</span><br><span class="line">    redirectedFrom?: Location</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.matcher.match(raw, current, redirectedFrom)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> currentRoute (): ?Route &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.history &amp;&amp; <span class="keyword">this</span>.history.current</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init (app: any <span class="comment">/* Vue component instance */</span>) &#123;</span><br><span class="line">    <span class="comment">// åœ¨åˆå§‹åŒ–Vue-Routerä¹‹å‰å¿…é¡»å…ˆé€šè¿‡Vue.use(VueRouter)æ³¨å†Œ</span></span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; assert(</span><br><span class="line">      install.installed,</span><br><span class="line">      <span class="string">`not installed. Make sure to call \`Vue.use(VueRouter)\` `</span> +</span><br><span class="line">      <span class="string">`before creating root instance.`</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.apps.push(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up app destroyed handler</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-router/issues/2639</span></span><br><span class="line">    app.$once(<span class="string">'hook:destroyed'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="comment">// clean out app from this.apps array once destroyed</span></span><br><span class="line">      <span class="keyword">const</span> index = <span class="keyword">this</span>.apps.indexOf(app)</span><br><span class="line">      <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) <span class="keyword">this</span>.apps.splice(index, <span class="number">1</span>)</span><br><span class="line">      <span class="comment">// ensure we still have a main app or null if no apps</span></span><br><span class="line">      <span class="comment">// we do not release the router so it can be reused</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.app === app) <span class="keyword">this</span>.app = <span class="keyword">this</span>.apps[<span class="number">0</span>] || <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main app previously initialized</span></span><br><span class="line">    <span class="comment">// return as we don't need to set up new history listener</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.app) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.app = app</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> history = <span class="keyword">this</span>.history</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HTML5History) &#123;</span><br><span class="line">      history.transitionTo(history.getCurrentLocation())</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HashHistory) &#123;</span><br><span class="line">      <span class="keyword">const</span> setupHashListener = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        history.setupListeners()</span><br><span class="line">      &#125;</span><br><span class="line">      history.transitionTo(</span><br><span class="line">        history.getCurrentLocation(),</span><br><span class="line">        setupHashListener,</span><br><span class="line">        setupHashListener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    history.listen(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">        app._route = route</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  beforeEach (fn: <span class="built_in">Function</span>): <span class="built_in">Function</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> registerHook(<span class="keyword">this</span>.beforeHooks, fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  beforeResolve (fn: <span class="built_in">Function</span>): <span class="built_in">Function</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> registerHook(<span class="keyword">this</span>.resolveHooks, fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  afterEach (fn: <span class="built_in">Function</span>): <span class="built_in">Function</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> registerHook(<span class="keyword">this</span>.afterHooks, fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onReady (cb: <span class="built_in">Function</span>, errorCb?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.onReady(cb, errorCb)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onError (errorCb: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.onError(errorCb)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.push(location, onComplete, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  replace (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.replace(location, onComplete, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  go (n: number) &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.go(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  back () &#123;</span><br><span class="line">    <span class="keyword">this</span>.go(<span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  forward () &#123;</span><br><span class="line">    <span class="keyword">this</span>.go(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMatchedComponents (to?: RawLocation | Route): <span class="built_in">Array</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> route: any = to</span><br><span class="line">      ? to.matched</span><br><span class="line">        ? to</span><br><span class="line">        : <span class="keyword">this</span>.resolve(to).route</span><br><span class="line">      : <span class="keyword">this</span>.currentRoute</span><br><span class="line">    <span class="keyword">if</span> (!route) &#123;</span><br><span class="line">      <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [].concat.apply([], route.matched.map(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.keys(m.components).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> m.components[key]</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resolve (</span><br><span class="line">    to: RawLocation,</span><br><span class="line">    current?: Route,</span><br><span class="line">    append?: boolean</span><br><span class="line">  ): &#123;</span><br><span class="line">    location: Location,</span><br><span class="line">    route: Route,</span><br><span class="line">    href: string,</span><br><span class="line">    <span class="comment">// for backwards compat</span></span><br><span class="line">    normalizedTo: Location,</span><br><span class="line">    resolved: Route</span><br><span class="line">  &#125; &#123;</span><br><span class="line">    current = current || <span class="keyword">this</span>.history.current</span><br><span class="line">    <span class="keyword">const</span> location = normalizeLocation(</span><br><span class="line">      to,</span><br><span class="line">      current,</span><br><span class="line">      append,</span><br><span class="line">      <span class="keyword">this</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> route = <span class="keyword">this</span>.match(location, current)</span><br><span class="line">    <span class="keyword">const</span> fullPath = route.redirectedFrom || route.fullPath</span><br><span class="line">    <span class="keyword">const</span> base = <span class="keyword">this</span>.history.base</span><br><span class="line">    <span class="keyword">const</span> href = createHref(base, fullPath, <span class="keyword">this</span>.mode)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      location,</span><br><span class="line">      route,</span><br><span class="line">      href,</span><br><span class="line">      <span class="comment">// for backwards compat</span></span><br><span class="line">      normalizedTo: location,</span><br><span class="line">      resolved: route</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addRoutes (routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.matcher.addRoutes(routes)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.history.current !== START) &#123;</span><br><span class="line">      <span class="keyword">this</span>.history.transitionTo(<span class="keyword">this</span>.history.getCurrentLocation())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerHook</span> (<span class="params">list: Array&lt;any&gt;, fn: Function</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  list.push(fn)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> i = list.indexOf(fn)</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">-1</span>) list.splice(i, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHref</span> (<span class="params">base: string, fullPath: string, mode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> path = mode === <span class="string">'hash'</span> ? <span class="string">'#'</span> + fullPath : fullPath</span><br><span class="line">  <span class="keyword">return</span> base ? cleanPath(base + <span class="string">'/'</span> + path) : path</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VueRouter.install = install</span><br><span class="line">VueRouter.version = <span class="string">'__VERSION__'</span></span><br><span class="line"><span class="comment">// é€šè¿‡linkæ ‡ç­¾å¼•ç”¨jsçš„å®è¡Œè‡ªåŠ¨æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">if</span> (inBrowser &amp;&amp; <span class="built_in">window</span>.Vue) &#123;</span><br><span class="line">  <span class="built_in">window</span>.Vue.use(VueRouter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°é‡Œé¢å®šä¹‰äº†ä¸€äº›å±æ€§ï¼Œå…¶ä¸­<code>this.app</code>è¡¨ç¤ºæ ¹<code>Vue</code>çš„å®ä¾‹ï¼Œ<code>this.apps</code>å­˜å‚¨å«æœ‰<code>this.$options.router</code>å±æ€§çš„Vueå®ä¾‹ï¼Œåˆå§‹åŒ–<code>Vue-Router</code>åä¼ å…¥çš„é…ç½®éƒ½ä¼šå­˜å‚¨åœ¨<code>this.options</code>ï¼Œ<code>this.beforeHooks</code>ã€<code>this.resolveHooks</code>ã€<code>this.afterHooks</code>ç”¨æ¥å­˜å‚¨é’©å­å‡½æ•°ï¼Œ<code>this.matcher</code>æ˜¯è·¯ç”±åŒ¹é…åè¿”å›çš„å¯¹è±¡ï¼Œ<code>this.fallback</code>ä¼šæ ¹æ®é…ç½®çš„<code>mode</code>å‚æ•°ä»¥åŠæµè§ˆå™¨æ”¯æŒåº¦æ¥å†³å®šç»™æ˜¯å¦å›é€€åˆ°<code>hash</code>æ¨¡å¼ï¼Œ<code>this.mode</code>å°±æ˜¯è·¯ç”±åˆ›å»ºçš„æ¨¡å¼ï¼Œè¿™é‡Œæä¾›<code>hash</code>ã€<code>history</code>ã€<code>abstract</code>ä¸‰ç§æ¨¡å¼ï¼Œ<code>this.history</code>è¡¨ç¤ºæ ¹æ®ä¸åŒçš„è·¯ç”±æ¨¡å¼æ¥åˆ›å»ºçš„è·¯ç”±<code>history</code>çš„å…·ä½“å®ç°æ–¹å¼ã€‚</p>
<p>å®ä¾‹åŒ–<code>Vue-Router</code>ä¹‹åä¼šè¿”å›å®ƒçš„å®ä¾‹<code>router</code>ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨<code>Vue-Router</code>çš„æ—¶å€™éœ€è¦åœ¨åˆå§‹åŒ–<code>Vue</code>çš„æ—¶å€™ä¼ å…¥è¿™ä¸ª<code>router</code>å±æ€§ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  router,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™ä¼šæŠŠ<code>router</code>å±æ€§é…ç½®åˆ°<code>this.$options</code>ï¼Œå›æƒ³åˆ°<code>install.js</code>é‡Œé¢åœ¨<code>beforeCreate</code>é’©å­å‡½æ•°é‡Œé¢æ‰§è¡Œçš„æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeCreate () &#123;</span><br><span class="line">  <span class="comment">// æ ¹ç»„ä»¶çš„$optionsä¸Šæ‰æœ‰routerå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(<span class="keyword">this</span>.$options.router)) &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ ¹è·¯ç”±</span></span><br><span class="line">    <span class="keyword">this</span>._routerRoot = <span class="keyword">this</span></span><br><span class="line">    <span class="comment">// è·å–åˆ°æ ¹ç»„ä»¶ä¸Šçš„routerå®ä¾‹</span></span><br><span class="line">    <span class="keyword">this</span>._router = <span class="keyword">this</span>.$options.router</span><br><span class="line">    <span class="comment">// è·¯ç”±åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">this</span>._router.init(<span class="keyword">this</span>)</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¼šæ‰§è¡Œ<code>init</code>æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">init (app: any <span class="comment">/* Vue component instance */</span>) &#123;</span><br><span class="line">  <span class="comment">// åœ¨åˆå§‹åŒ–Vue-Routerä¹‹å‰å¿…é¡»å…ˆé€šè¿‡Vue.use(VueRouter)æ³¨å†Œ</span></span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; assert(</span><br><span class="line">    install.installed,</span><br><span class="line">    <span class="string">`not installed. Make sure to call \`Vue.use(VueRouter)\` `</span> +</span><br><span class="line">    <span class="string">`before creating root instance.`</span></span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// å­˜å‚¨appå®ä¾‹</span></span><br><span class="line">  <span class="keyword">this</span>.apps.push(app)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up app destroyed handler</span></span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue-router/issues/2639</span></span><br><span class="line">  app.$once(<span class="string">'hook:destroyed'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// clean out app from this.apps array once destroyed</span></span><br><span class="line">    <span class="keyword">const</span> index = <span class="keyword">this</span>.apps.indexOf(app)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) <span class="keyword">this</span>.apps.splice(index, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// ensure we still have a main app or null if no apps</span></span><br><span class="line">    <span class="comment">// we do not release the router so it can be reused</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.app === app) <span class="keyword">this</span>.app = <span class="keyword">this</span>.apps[<span class="number">0</span>] || <span class="literal">null</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// main app previously initialized</span></span><br><span class="line">  <span class="comment">// return as we don't need to set up new history listener</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.app) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.app = app</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> history = <span class="keyword">this</span>.history</span><br><span class="line">  <span class="comment">// æ ¹æ®historyå®ç°çš„æ–¹å¼ä¸åŒæ‰§è¡Œä¸åŒçš„é€»è¾‘</span></span><br><span class="line">  <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HTML5History) &#123;</span><br><span class="line">    history.transitionTo(history.getCurrentLocation())</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HashHistory) &#123;</span><br><span class="line">    <span class="keyword">const</span> setupHashListener = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      history.setupListeners()</span><br><span class="line">    &#125;</span><br><span class="line">    history.transitionTo(</span><br><span class="line">      history.getCurrentLocation(),</span><br><span class="line">      setupHashListener,</span><br><span class="line">      setupHashListener</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ›´æ–°æ ¹ç»„ä»¶çš„è·¯ç”±å¯¹è±¡</span></span><br><span class="line">  history.listen(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">      app._route = route</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>init</code>å…¶å®æ²¡å¹²å¾ˆå¤šäº‹æƒ…ï¼Œé¦–å…ˆæŠŠä¼ å…¥çš„<code>Vue</code>å®ä¾‹å­˜å‚¨åˆ°<code>apps</code>æ•°ç»„ä¸­ï¼Œç„¶åæŠŠ<code>this.history</code>èµ‹å€¼ç»™ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼Œæ ¹æ®<code>this.history</code>å®ç°æ–¹å¼çš„ä¸åŒæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œæœ€åé€šè¿‡<code>history</code>çš„å›è°ƒæ›´æ–°è·¯ç”±å¯¹è±¡ä¹Ÿå°±æ˜¯<code>this.$route</code>ã€‚</p>
<p>æ— è®º<code>this.history</code>æ˜¯åŸºäº<code>history</code>è¿˜æ˜¯<code>hash</code>å®ç°çš„ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨<code>transitionTo</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨<code>src/history/base.js</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">transitionTo (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> route = <span class="keyword">this</span>.router.match(location, <span class="keyword">this</span>.current)</span><br><span class="line">    <span class="keyword">this</span>.confirmTransition(route, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå°±æ˜¯è°ƒç”¨<code>match</code>æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">match (</span><br><span class="line">  raw: RawLocation,</span><br><span class="line">  current?: Route,</span><br><span class="line">  redirectedFrom?: Location</span><br><span class="line">): Route &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.matcher.match(raw, current, redirectedFrom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬å¯ä»¥å…ˆæŠŠä¸Šé¢çš„é€»è¾‘æ”¾ä¸€è¾¹ï¼Œå…ˆäº†è§£ä¸€ä¸‹<code>matchers</code>çš„æ„å»ºï¼Œç›¸å…³çš„æºç åœ¨<code>src/create-matcher.js</code>:</p>
<h5 id="matchçš„å®ç°"><a href="#matchçš„å®ç°" class="headerlink" title="matchçš„å®ç°"></a>matchçš„å®ç°</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> type VueRouter <span class="keyword">from</span> <span class="string">'./index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolvePath &#125; <span class="keyword">from</span> <span class="string">'./util/path'</span></span><br><span class="line"><span class="keyword">import</span> &#123; assert, warn &#125; <span class="keyword">from</span> <span class="string">'./util/warn'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRoute &#125; <span class="keyword">from</span> <span class="string">'./util/route'</span></span><br><span class="line"><span class="keyword">import</span> &#123; fillParams &#125; <span class="keyword">from</span> <span class="string">'./util/params'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRouteMap &#125; <span class="keyword">from</span> <span class="string">'./create-route-map'</span></span><br><span class="line"><span class="keyword">import</span> &#123; normalizeLocation &#125; <span class="keyword">from</span> <span class="string">'./util/location'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type Matcher = &#123;</span><br><span class="line">  match: <span class="function">(<span class="params">raw: RawLocation, current?: Route, redirectedFrom?: Location</span>) =&gt;</span> Route;</span><br><span class="line">  addRoutes: <span class="function">(<span class="params">routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createMatcher</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  routes: Array&lt;RouteConfig&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  router: VueRouter</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Matcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</span><br><span class="line">  <span class="comment">// æ·»åŠ è·¯ç”±è·¯å¾„å…³ç³»æ˜ å°„</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoutes</span> (<span class="params">routes</span>) </span>&#123;</span><br><span class="line">    createRouteMap(routes, pathList, pathMap, nameMap)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">match</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    raw: RawLocation,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentRoute?: Route,</span></span></span><br><span class="line"><span class="function"><span class="params">    redirectedFrom?: Location</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®rawå’ŒcurrentRouteè®¡ç®—å‡ºæ–°çš„location</span></span><br><span class="line">    <span class="keyword">const</span> location = normalizeLocation(raw, currentRoute, <span class="literal">false</span>, router)</span><br><span class="line">    <span class="keyword">const</span> &#123; name &#125; = location</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯å‘½åè·¯ç”±ï¼Œå–å‡ºå¯¹åº”çš„è·¯ç”±record</span></span><br><span class="line">      <span class="keyword">const</span> record = nameMap[name]</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        warn(record, <span class="string">`Route with name '<span class="subst">$&#123;name&#125;</span>' does not exist`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç”Ÿæˆä¸€æ¡æ–°è®°å½•</span></span><br><span class="line">      <span class="keyword">if</span> (!record) <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">      <span class="keyword">const</span> paramNames = record.regex.keys</span><br><span class="line">        .filter(<span class="function"><span class="params">key</span> =&gt;</span> !key.optional)</span><br><span class="line">        .map(<span class="function"><span class="params">key</span> =&gt;</span> key.name)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> location.params !== <span class="string">'object'</span>) &#123;</span><br><span class="line">        location.params = &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// èµ‹å€¼params</span></span><br><span class="line">      <span class="keyword">if</span> (currentRoute &amp;&amp; <span class="keyword">typeof</span> currentRoute.params === <span class="string">'object'</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> currentRoute.params) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(key <span class="keyword">in</span> location.params) &amp;&amp; paramNames.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">            location.params[key] = currentRoute.params[key]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (record) &#123;</span><br><span class="line">        location.path = fillParams(record.path, location.params, <span class="string">`named route "<span class="subst">$&#123;name&#125;</span>"`</span>)</span><br><span class="line">        <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.path) &#123;</span><br><span class="line">      location.params = &#123;&#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pathList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> path = pathList[i]</span><br><span class="line">        <span class="keyword">const</span> record = pathMap[path]</span><br><span class="line">        <span class="keyword">if</span> (matchRoute(record.regex, location.path, location.params)) &#123;</span><br><span class="line">          <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no match</span></span><br><span class="line">    <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">redirect</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    record: RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">    location: Location</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> originalRedirect = record.redirect</span><br><span class="line">    <span class="keyword">let</span> redirect = <span class="keyword">typeof</span> originalRedirect === <span class="string">'function'</span></span><br><span class="line">      ? originalRedirect(createRoute(record, location, <span class="literal">null</span>, router))</span><br><span class="line">      : originalRedirect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> redirect === <span class="string">'string'</span>) &#123;</span><br><span class="line">      redirect = &#123; <span class="attr">path</span>: redirect &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!redirect || <span class="keyword">typeof</span> redirect !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="literal">false</span>, <span class="string">`invalid redirect option: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(redirect)&#125;</span>`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> re: <span class="built_in">Object</span> = redirect</span><br><span class="line">    <span class="keyword">const</span> &#123; name, path &#125; = re</span><br><span class="line">    <span class="keyword">let</span> &#123; query, hash, params &#125; = location</span><br><span class="line">    query = re.hasOwnProperty(<span class="string">'query'</span>) ? re.query : query</span><br><span class="line">    hash = re.hasOwnProperty(<span class="string">'hash'</span>) ? re.hash : hash</span><br><span class="line">    params = re.hasOwnProperty(<span class="string">'params'</span>) ? re.params : params</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      <span class="comment">// resolved named direct</span></span><br><span class="line">      <span class="keyword">const</span> targetRecord = nameMap[name]</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        assert(targetRecord, <span class="string">`redirect failed: named route "<span class="subst">$&#123;name&#125;</span>" not found.`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> match(&#123;</span><br><span class="line">        _normalized: <span class="literal">true</span>,</span><br><span class="line">        name,</span><br><span class="line">        query,</span><br><span class="line">        hash,</span><br><span class="line">        params</span><br><span class="line">      &#125;, <span class="literal">undefined</span>, location)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path) &#123;</span><br><span class="line">      <span class="comment">// 1. resolve relative redirect</span></span><br><span class="line">      <span class="keyword">const</span> rawPath = resolveRecordPath(path, record)</span><br><span class="line">      <span class="comment">// 2. resolve params</span></span><br><span class="line">      <span class="keyword">const</span> resolvedPath = fillParams(rawPath, params, <span class="string">`redirect route with path "<span class="subst">$&#123;rawPath&#125;</span>"`</span>)</span><br><span class="line">      <span class="comment">// 3. rematch with existing query and hash</span></span><br><span class="line">      <span class="keyword">return</span> match(&#123;</span><br><span class="line">        _normalized: <span class="literal">true</span>,</span><br><span class="line">        path: resolvedPath,</span><br><span class="line">        query,</span><br><span class="line">        hash</span><br><span class="line">      &#125;, <span class="literal">undefined</span>, location)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        warn(<span class="literal">false</span>, <span class="string">`invalid redirect option: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(redirect)&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">alias</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    record: RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">    location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">    matchAs: string</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> aliasedPath = fillParams(matchAs, location.params, <span class="string">`aliased route with path "<span class="subst">$&#123;matchAs&#125;</span>"`</span>)</span><br><span class="line">    <span class="keyword">const</span> aliasedMatch = match(&#123;</span><br><span class="line">      _normalized: <span class="literal">true</span>,</span><br><span class="line">      path: aliasedPath</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (aliasedMatch) &#123;</span><br><span class="line">      <span class="keyword">const</span> matched = aliasedMatch.matched</span><br><span class="line">      <span class="keyword">const</span> aliasedRecord = matched[matched.length - <span class="number">1</span>]</span><br><span class="line">      location.params = aliasedMatch.params</span><br><span class="line">      <span class="keyword">return</span> _createRoute(aliasedRecord, location)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createRoute</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    record: ?RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">    location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">    redirectedFrom?: Location</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">      <span class="keyword">return</span> redirect(record, redirectedFrom || location)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (record &amp;&amp; record.matchAs) &#123;</span><br><span class="line">      <span class="keyword">return</span> alias(record, location, record.matchAs)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createRoute(record, location, redirectedFrom, router)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    match,</span><br><span class="line">    addRoutes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchRoute</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  regex: RouteRegExp,</span></span></span><br><span class="line"><span class="function"><span class="params">  path: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  params: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> m = path.match(regex)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, len = m.length; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = regex.keys[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">const</span> val = <span class="keyword">typeof</span> m[i] === <span class="string">'string'</span> ? <span class="built_in">decodeURIComponent</span>(m[i]) : m[i]</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">      <span class="comment">// Fix #1994: using * with props: true generates a param named 0</span></span><br><span class="line">      params[key.name || <span class="string">'pathMatch'</span>] = val</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveRecordPath</span> (<span class="params">path: string, record: RouteRecord</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> resolvePath(path, record.parent ? record.parent.path : <span class="string">'/'</span>, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createMatcher</code>æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯åˆå§‹åŒ–è·¯ç”±çš„é…ç½®å¯¹è±¡<code>routes</code>ï¼Œç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬çš„è·¯ç”±å®ä¾‹<code>router</code>ï¼Œé¦–å…ˆä¼šè·‘ä¸€ä¸ª<code>createRouteMap</code>çš„é€»è¾‘ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªè·¯ç”±æ˜ å°„ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨<code>src/create-route-map.js</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Regexp <span class="keyword">from</span> <span class="string">'path-to-regexp'</span></span><br><span class="line"><span class="keyword">import</span> &#123; cleanPath &#125; <span class="keyword">from</span> <span class="string">'./util/path'</span></span><br><span class="line"><span class="keyword">import</span> &#123; assert, warn &#125; <span class="keyword">from</span> <span class="string">'./util/warn'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouteMap</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  routes: Array&lt;RouteConfig&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldPathList?: Array&lt;string&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldPathMap?: Dictionary&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldNameMap?: Dictionary&lt;RouteRecord&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): </span>&#123;</span><br><span class="line">  pathList: <span class="built_in">Array</span>&lt;string&gt;;</span><br><span class="line">  pathMap: Dictionary&lt;RouteRecord&gt;;</span><br><span class="line">  nameMap: Dictionary&lt;RouteRecord&gt;;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="comment">// the path list is used to control path matching priority</span></span><br><span class="line">  <span class="keyword">const</span> pathList: <span class="built_in">Array</span>&lt;string&gt; = oldPathList || []</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> pathMap: Dictionary&lt;RouteRecord&gt; = oldPathMap || <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> nameMap: Dictionary&lt;RouteRecord&gt; = oldNameMap || <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    addRouteRecord(pathList, pathMap, nameMap, route)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// ç¡®ä¿é€šé…ç¬¦çš„è·¯å¾„åœ¨æœ€åæ‰è¢«åŒ¹é…</span></span><br><span class="line">  <span class="comment">// ensure wildcard routes are always at the end</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = pathList.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pathList[i] === <span class="string">'*'</span>) &#123;</span><br><span class="line">      pathList.push(pathList.splice(i, <span class="number">1</span>)[<span class="number">0</span>])</span><br><span class="line">      l--</span><br><span class="line">      i--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    pathList,</span><br><span class="line">    pathMap,</span><br><span class="line">    nameMap</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRouteRecord</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  pathList: Array&lt;string&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pathMap: Dictionary&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  nameMap: Dictionary&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  route: RouteConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent?: RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  matchAs?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path, name &#125; = route</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// pathä¸èƒ½ä¸ºç©ºå¹¶ä¸”componentçš„å€¼å¿…é¡»ç”¨ä¸€ä¸ªç»„ä»¶åè€Œä¸æ˜¯ä¸€ä¸ªstringå­—ç¬¦ä¸²</span></span><br><span class="line">    assert(path != <span class="literal">null</span>, <span class="string">`"path" is required in a route configuration.`</span>)</span><br><span class="line">    assert(</span><br><span class="line">      <span class="keyword">typeof</span> route.component !== <span class="string">'string'</span>,</span><br><span class="line">      <span class="string">`route config "component" for path: <span class="subst">$&#123;<span class="built_in">String</span>(path || name)&#125;</span> cannot be a `</span> +</span><br><span class="line">      <span class="string">`string id. Use an actual component instead.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// pathToRegexpOptionsæ˜¯ç¼–è¯‘æ­£åˆ™çš„é€‰é¡¹</span></span><br><span class="line">  <span class="keyword">const</span> pathToRegexpOptions: PathToRegexpOptions = route.pathToRegexpOptions || &#123;&#125;</span><br><span class="line">  <span class="comment">// normalize path</span></span><br><span class="line">  <span class="keyword">const</span> normalizedPath = normalizePath(</span><br><span class="line">    path,</span><br><span class="line">    parent,</span><br><span class="line">    pathToRegexpOptions.strict</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// caseSensitiveåŒ¹é…è§„åˆ™æ˜¯å¦å¤§å°å†™æ•æ„Ÿï¼Ÿ(é»˜è®¤å€¼ï¼šfalse)</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route.caseSensitive === <span class="string">'boolean'</span>) &#123;</span><br><span class="line">    pathToRegexpOptions.sensitive = route.caseSensitive</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> record: RouteRecord = &#123;</span><br><span class="line">    path: normalizedPath,</span><br><span class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</span><br><span class="line">    components: route.components || &#123; <span class="attr">default</span>: route.component &#125;,</span><br><span class="line">    instances: &#123;&#125;,</span><br><span class="line">    name,</span><br><span class="line">    parent,</span><br><span class="line">    matchAs,</span><br><span class="line">    redirect: route.redirect,</span><br><span class="line">    beforeEnter: route.beforeEnter,</span><br><span class="line">    meta: route.meta || &#123;&#125;,</span><br><span class="line">    props: route.props == <span class="literal">null</span></span><br><span class="line">      ? &#123;&#125;</span><br><span class="line">      : route.components</span><br><span class="line">        ? route.props</span><br><span class="line">        : &#123; <span class="attr">default</span>: route.props &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰å­è·¯ç”±</span></span><br><span class="line">  <span class="keyword">if</span> (route.children) &#123;</span><br><span class="line">    <span class="comment">// Warn if route is named, does not redirect and has a default child route.</span></span><br><span class="line">    <span class="comment">// If users navigate to this route by name, the default child will</span></span><br><span class="line">    <span class="comment">// not be rendered (GH Issue #629)</span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (route.name &amp;&amp; !route.redirect &amp;&amp; route.children.some(<span class="function"><span class="params">child</span> =&gt;</span> <span class="regexp">/^\/?$/</span>.test(child.path))) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">`Named Route '<span class="subst">$&#123;route.name&#125;</span>' has a default child route. `</span> +</span><br><span class="line">          <span class="string">`When navigating to this named route (:to="&#123;name: '<span class="subst">$&#123;route.name&#125;</span>'"), `</span> +</span><br><span class="line">          <span class="string">`the default child route will not be rendered. Remove the name from `</span> +</span><br><span class="line">          <span class="string">`this route and use the name of the default child route for named `</span> +</span><br><span class="line">          <span class="string">`links instead.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯æ·»åŠ å­è·¯ç”±è·¯å¾„</span></span><br><span class="line">    route.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> childMatchAs = matchAs</span><br><span class="line">        ? cleanPath(<span class="string">`<span class="subst">$&#123;matchAs&#125;</span>/<span class="subst">$&#123;child.path&#125;</span>`</span>)</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line">      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¾ç½®äº†è·¯ç”±åˆ«å</span></span><br><span class="line">  <span class="keyword">if</span> (route.alias !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// ç»Ÿä¸€è½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> aliases = <span class="built_in">Array</span>.isArray(route.alias)</span><br><span class="line">      ? route.alias</span><br><span class="line">      : [route.alias]</span><br><span class="line"></span><br><span class="line">    aliases.forEach(<span class="function"><span class="params">alias</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> aliasRoute = &#123;</span><br><span class="line">        path: alias,</span><br><span class="line">        children: route.children</span><br><span class="line">      &#125;</span><br><span class="line">      addRouteRecord(</span><br><span class="line">        pathList,</span><br><span class="line">        pathMap,</span><br><span class="line">        nameMap,</span><br><span class="line">        aliasRoute,</span><br><span class="line">        parent,</span><br><span class="line">        record.path || <span class="string">'/'</span> <span class="comment">// matchAs</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ pathè®°å½•ä»¥åŠå»ºç«‹pathå’Œè®°å½•çš„å¯¹åº”å…³ç³»</span></span><br><span class="line">  <span class="keyword">if</span> (!pathMap[record.path]) &#123;</span><br><span class="line">    pathList.push(record.path)</span><br><span class="line">    pathMap[record.path] = record</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœé…ç½®äº†å‘½åè·¯ç”±ï¼Œç»™nameå’Œrecordå»ºç«‹æ˜ å°„å…³ç³»</span></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!nameMap[name]) &#123;</span><br><span class="line">      nameMap[name] = record</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !matchAs) &#123;</span><br><span class="line">      <span class="comment">// å·²ç»æœ‰è¿™ä¸ªå‘½åçš„è·¯ç”±å­˜åœ¨å¹¶ä¸”æ²¡æœ‰ç»™è¿™ä¸ªè·¯ç”±è®¾ç½®é‡å®šå‘ï¼Œè¯´æ˜ç»™äº†é‡å¤å‘½å</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">`Duplicate named routes definition: `</span> +</span><br><span class="line">        <span class="string">`&#123; name: "<span class="subst">$&#123;name&#125;</span>", path: "<span class="subst">$&#123;record.path&#125;</span>" &#125;`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileRouteRegex</span> (<span class="params">path: string, pathToRegexpOptions: PathToRegexpOptions</span>): <span class="title">RouteRegExp</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> regex = Regexp(path, [], pathToRegexpOptions)</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys: any = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">    regex.keys.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// æœ‰é‡å¤çš„åŠ¨æ€è·¯å¾„å‚æ•°</span></span><br><span class="line">      warn(!keys[key.name], <span class="string">`Duplicate param keys in route with path: "<span class="subst">$&#123;path&#125;</span>"`</span>)</span><br><span class="line">      keys[key.name] = <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> regex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizePath</span> (<span class="params">path: string, parent?: RouteRecord, strict?: boolean</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ›¿æ¢æ ¹è·¯ç”±è·¯å¾„</span></span><br><span class="line">  <span class="keyword">if</span> (!strict) path = path.replace(<span class="regexp">/\/$/</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">if</span> (path[<span class="number">0</span>] === <span class="string">'/'</span>) <span class="keyword">return</span> path</span><br><span class="line">  <span class="keyword">if</span> (parent == <span class="literal">null</span>) <span class="keyword">return</span> path</span><br><span class="line">  <span class="comment">// å°†//çš„è·¯å¾„æ›¿æ¢æˆ/</span></span><br><span class="line">  <span class="keyword">return</span> cleanPath(<span class="string">`<span class="subst">$&#123;parent.path&#125;</span>/<span class="subst">$&#123;path&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°†è·¯ç”±é…ç½®è½¬æ¢æˆä¸€ç»„ç»„æ˜ å°„å…³ç³»è¡¨ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  pathList,</span><br><span class="line">  pathMap,</span><br><span class="line">  nameMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>pathList</code>å­˜å‚¨äº†æ‰€æœ‰çš„<code>path</code>ï¼Œ<code>pathMap</code>è¡¨ç¤ºäº†<code>path</code>åˆ°<code>RouteRecord</code>å¯¹è±¡çš„ä¸€ä¸€æ˜ å°„å…³ç³»ï¼Œ<code>nameMap</code>åˆ™è¡¨ç¤ºäº†<code>name</code>åˆ°<code>RouteRecord</code>å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼Œ<code>RouteRecord</code>å¯¹è±¡æ˜¯å¯¹è·¯ç”±é…ç½®å‚æ•°<code>routes</code>æ¯ä¸€é¡¹è¿›è¡Œéå†åè°ƒç”¨<code>addRouteRecord</code>æ–¹æ³•ç”Ÿæˆçš„ä¸€æ¡è®°å½•ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRouteRecord</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  pathList: Array&lt;string&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pathMap: Dictionary&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  nameMap: Dictionary&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  route: RouteConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent?: RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  matchAs?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path, name &#125; = route</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// pathä¸èƒ½ä¸ºç©ºå¹¶ä¸”componentçš„å€¼å¿…é¡»ç”¨ä¸€ä¸ªç»„ä»¶åè€Œä¸æ˜¯ä¸€ä¸ªstringå­—ç¬¦ä¸²</span></span><br><span class="line">    assert(path != <span class="literal">null</span>, <span class="string">`"path" is required in a route configuration.`</span>)</span><br><span class="line">    assert(</span><br><span class="line">      <span class="keyword">typeof</span> route.component !== <span class="string">'string'</span>,</span><br><span class="line">      <span class="string">`route config "component" for path: <span class="subst">$&#123;<span class="built_in">String</span>(path || name)&#125;</span> cannot be a `</span> +</span><br><span class="line">      <span class="string">`string id. Use an actual component instead.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// pathToRegexpOptionsæ˜¯ç¼–è¯‘æ­£åˆ™çš„é€‰é¡¹</span></span><br><span class="line">  <span class="keyword">const</span> pathToRegexpOptions: PathToRegexpOptions = route.pathToRegexpOptions || &#123;&#125;</span><br><span class="line">  <span class="comment">// normalize path</span></span><br><span class="line">  <span class="keyword">const</span> normalizedPath = normalizePath(</span><br><span class="line">    path,</span><br><span class="line">    parent,</span><br><span class="line">    pathToRegexpOptions.strict</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// caseSensitiveåŒ¹é…è§„åˆ™æ˜¯å¦å¤§å°å†™æ•æ„Ÿï¼Ÿ(é»˜è®¤å€¼ï¼šfalse)</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route.caseSensitive === <span class="string">'boolean'</span>) &#123;</span><br><span class="line">    pathToRegexpOptions.sensitive = route.caseSensitive</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> record: RouteRecord = &#123;</span><br><span class="line">    path: normalizedPath,</span><br><span class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</span><br><span class="line">    components: route.components || &#123; <span class="attr">default</span>: route.component &#125;,</span><br><span class="line">    instances: &#123;&#125;,</span><br><span class="line">    name,</span><br><span class="line">    parent,</span><br><span class="line">    matchAs,</span><br><span class="line">    redirect: route.redirect,</span><br><span class="line">    beforeEnter: route.beforeEnter,</span><br><span class="line">    meta: route.meta || &#123;&#125;,</span><br><span class="line">    props: route.props == <span class="literal">null</span></span><br><span class="line">      ? &#123;&#125;</span><br><span class="line">      : route.components</span><br><span class="line">        ? route.props</span><br><span class="line">        : &#123; <span class="attr">default</span>: route.props &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰å­è·¯ç”±</span></span><br><span class="line">  <span class="keyword">if</span> (route.children) &#123;</span><br><span class="line">    <span class="comment">// Warn if route is named, does not redirect and has a default child route.</span></span><br><span class="line">    <span class="comment">// If users navigate to this route by name, the default child will</span></span><br><span class="line">    <span class="comment">// not be rendered (GH Issue #629)</span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (route.name &amp;&amp; !route.redirect &amp;&amp; route.children.some(<span class="function"><span class="params">child</span> =&gt;</span> <span class="regexp">/^\/?$/</span>.test(child.path))) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">`Named Route '<span class="subst">$&#123;route.name&#125;</span>' has a default child route. `</span> +</span><br><span class="line">          <span class="string">`When navigating to this named route (:to="&#123;name: '<span class="subst">$&#123;route.name&#125;</span>'"), `</span> +</span><br><span class="line">          <span class="string">`the default child route will not be rendered. Remove the name from `</span> +</span><br><span class="line">          <span class="string">`this route and use the name of the default child route for named `</span> +</span><br><span class="line">          <span class="string">`links instead.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯æ·»åŠ å­è·¯ç”±è·¯å¾„</span></span><br><span class="line">    route.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> childMatchAs = matchAs</span><br><span class="line">        ? cleanPath(<span class="string">`<span class="subst">$&#123;matchAs&#125;</span>/<span class="subst">$&#123;child.path&#125;</span>`</span>)</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line">      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¾ç½®äº†è·¯ç”±åˆ«å</span></span><br><span class="line">  <span class="keyword">if</span> (route.alias !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// ç»Ÿä¸€è½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> aliases = <span class="built_in">Array</span>.isArray(route.alias)</span><br><span class="line">      ? route.alias</span><br><span class="line">      : [route.alias]</span><br><span class="line"></span><br><span class="line">    aliases.forEach(<span class="function"><span class="params">alias</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> aliasRoute = &#123;</span><br><span class="line">        path: alias,</span><br><span class="line">        children: route.children</span><br><span class="line">      &#125;</span><br><span class="line">      addRouteRecord(</span><br><span class="line">        pathList,</span><br><span class="line">        pathMap,</span><br><span class="line">        nameMap,</span><br><span class="line">        aliasRoute,</span><br><span class="line">        parent,</span><br><span class="line">        record.path || <span class="string">'/'</span> <span class="comment">// matchAs</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ pathè®°å½•ä»¥åŠå»ºç«‹pathå’Œè®°å½•çš„å¯¹åº”å…³ç³»</span></span><br><span class="line">  <span class="keyword">if</span> (!pathMap[record.path]) &#123;</span><br><span class="line">    pathList.push(record.path)</span><br><span class="line">    pathMap[record.path] = record</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœé…ç½®äº†å‘½åè·¯ç”±ï¼Œç»™nameå’Œrecordå»ºç«‹æ˜ å°„å…³ç³»</span></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!nameMap[name]) &#123;</span><br><span class="line">      nameMap[name] = record</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !matchAs) &#123;</span><br><span class="line">      <span class="comment">// å·²ç»æœ‰è¿™ä¸ªå‘½åçš„è·¯ç”±å­˜åœ¨å¹¶ä¸”æ²¡æœ‰ç»™è¿™ä¸ªè·¯ç”±è®¾ç½®é‡å®šå‘ï¼Œè¯´æ˜ç»™äº†é‡å¤å‘½å</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">`Duplicate named routes definition: `</span> +</span><br><span class="line">        <span class="string">`&#123; name: "<span class="subst">$&#123;name&#125;</span>", path: "<span class="subst">$&#123;record.path&#125;</span>" &#125;`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šå¯¹<code>path</code>ä½¿ç”¨<code>normalizePath</code>è¿›è¡Œè§„èŒƒåŒ–å¤„ç†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizePath</span> (<span class="params">path: string, parent?: RouteRecord, strict?: boolean</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ›¿æ¢æ ¹è·¯ç”±è·¯å¾„</span></span><br><span class="line">  <span class="keyword">if</span> (!strict) path = path.replace(<span class="regexp">/\/$/</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="comment">// è¯´æ˜æ˜¯ä¸€çº§è·¯å¾„ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (path[<span class="number">0</span>] === <span class="string">'/'</span>) <span class="keyword">return</span> path</span><br><span class="line">  <span class="keyword">if</span> (parent == <span class="literal">null</span>) <span class="keyword">return</span> path</span><br><span class="line">  <span class="comment">//  å°†//çš„è·¯å¾„æ›¿æ¢æˆ/å¹¶ä¸”æ‹¼æ¥çˆ¶è·¯ç”±çš„è·¯å¾„</span></span><br><span class="line">  <span class="keyword">return</span> cleanPath(<span class="string">`<span class="subst">$&#123;parent.path&#125;</span>/<span class="subst">$&#123;path&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦ä½œç”¨å°±æ˜¯ç”Ÿæˆå¤šå±‚è·¯ç”±çš„å…·ä½“è·¯å¾„ï¼Œç„¶åæ ¹æ®å·²æœ‰å‚æ•°æ„å»º<code>RouteRecord</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const record: RouteRecord = &#123;</span><br><span class="line">  path: normalizedPath,</span><br><span class="line">  regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</span><br><span class="line">  components: route.components || &#123; default: route.component &#125;,</span><br><span class="line">  instances: &#123;&#125;,</span><br><span class="line">  name,</span><br><span class="line">  parent,</span><br><span class="line">  matchAs,</span><br><span class="line">  redirect: route.redirect,</span><br><span class="line">  beforeEnter: route.beforeEnter,</span><br><span class="line">  meta: route.meta || &#123;&#125;,</span><br><span class="line">  props: route.props == null</span><br><span class="line">    ? &#123;&#125;</span><br><span class="line">    : route.components</span><br><span class="line">      ? route.props</span><br><span class="line">      : &#123; default: route.props &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè§£é‡Šä¸‹<code>regex</code>è¿™ä¸ªå‚æ•°ï¼Œç”¨åˆ°äº†<code>path-to-regexp</code>è¿™ä¸ªåº“ï¼Œè¿™ä¸ªåº“å¯ä»¥æŠŠè·¯å¾„è½¬æ¢ä¸ºæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸¾ä¸ªæ —å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> keys = []</span><br><span class="line"><span class="keyword">const</span> regexp = pathToRegexp(<span class="string">'/foo/:bar'</span>, keys)</span><br><span class="line"><span class="comment">// regexp = /^\/foo\/([^\/]+?)\/?$/i</span></span><br><span class="line"><span class="comment">// keys = [&#123; name: 'bar', prefix: '/', delimiter: '/', optional: false, repeat: false, pattern: '[^\\/]+?' &#125;]</span></span><br></pre></td></tr></table></figure>
<p>ç”¨è¿™ä¸ªåº“ä½œä¸ºè·¯å¾„åŒ¹é…å¼•æ“æ˜¯ä¸ºäº†å®ç°å¯é€‰çš„åŠ¨æ€è·¯å¾„å‚æ•°ã€åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œç”šè‡³æ˜¯è‡ªå®šä¹‰æ­£åˆ™åŒ¹é…ã€‚<br>ç´§æ¥ç€åˆ¤æ–­æ˜¯å¦é…ç½®äº†å­è·¯ç”±ï¼Œç„¶åå¾ªç¯è°ƒç”¨<code>addRouteRecord</code>è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶æŠŠå½“å‰çš„<code>record</code>ä½œä¸º<code>parent</code>ï¼Œå¦‚æœè®¾ç½®äº†è·¯ç”±åˆ«åï¼Œä¹Ÿä¼šç»™åˆ«åæ·»åŠ ä¸€ä»½<code>record</code>ï¼Œæœ€åå°±æ˜¯æ›´æ–°æ˜ å°„è¡¨ï¼Œè¿”å›ä¸€ä¸ª<code>Array</code>å¯¹è±¡ä»¥åŠä¸¤ä¸ª<code>Dictionary</code>å¯¹è±¡ã€‚</p>
<p>å›åˆ°<code>create-matcher.js</code>ï¼Œå®ƒå¯¹å¤–æš´éœ²äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>addRoutes</code>å’Œ<code>match</code>ï¼Œåˆ†åˆ«ç”¨äºåŠ¨æ€æ·»åŠ è·¯ç”±é…ç½®ä»¥åŠè¿”å›ä¸€ä¸ªè·¯ç”±çš„è·¯å¾„ï¼Œå…ˆçœ‹<code>addRoutes</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function addRoutes (routes) &#123;</span><br><span class="line">    createRouteMap(routes, pathList, pathMap, nameMap)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯åœ¨ç°æœ‰çš„<code>pathList</code>ã€<code>pathMap</code>ã€<code>nameMap</code>ä¸ŠåŠ¨æ€æ·»åŠ ä¸€æ¡æ–°çºªå½•ï¼Œè¿™å‡ ä¸ªéƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰§è¡Œ<code>addRoutes</code>ä¹‹åéƒ½ä¼šè¢«ä¿®æ”¹ã€‚</p>
<p><code>match</code>å‡½æ•°ç›¸å¯¹å¤æ‚ä¸€ç‚¹ï¼Œæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥ä¸º<code>string</code>ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª<code>Location</code>å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå½“å‰çš„è·¯ç”±è·¯å¾„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿæ˜¯<code>Location</code>å¯¹è±¡ï¼Œè·Ÿé‡å®šå‘æœ‰å…³ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  raw: RawLocation,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentRoute?: Route,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom?: Location</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®rawå’ŒcurrentRouteè®¡ç®—å‡ºæ–°çš„location</span></span><br><span class="line">  <span class="keyword">const</span> location = normalizeLocation(raw, currentRoute, <span class="literal">false</span>, router)</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = location</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å‘½åè·¯ç”±ï¼Œå–å‡ºå¯¹åº”çš„è·¯ç”±record</span></span><br><span class="line">    <span class="keyword">const</span> record = nameMap[name]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(record, <span class="string">`Route with name '<span class="subst">$&#123;name&#125;</span>' does not exist`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆä¸€æ¡æ–°è®°å½•</span></span><br><span class="line">    <span class="keyword">if</span> (!record) <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">    <span class="keyword">const</span> paramNames = record.regex.keys</span><br><span class="line">      .filter(<span class="function"><span class="params">key</span> =&gt;</span> !key.optional)</span><br><span class="line">      .map(<span class="function"><span class="params">key</span> =&gt;</span> key.name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> location.params !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      location.params = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ‹å€¼params</span></span><br><span class="line">    <span class="keyword">if</span> (currentRoute &amp;&amp; <span class="keyword">typeof</span> currentRoute.params === <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> currentRoute.params) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(key <span class="keyword">in</span> location.params) &amp;&amp; paramNames.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">          location.params[key] = currentRoute.params[key]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (record) &#123;</span><br><span class="line">      location.path = fillParams(record.path, location.params, <span class="string">`named route "<span class="subst">$&#123;name&#125;</span>"`</span>)</span><br><span class="line">      <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.path) &#123;</span><br><span class="line">    location.params = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pathList.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> path = pathList[i]</span><br><span class="line">      <span class="keyword">const</span> record = pathMap[path]</span><br><span class="line">      <span class="keyword">if</span> (matchRoute(record.regex, location.path, location.params)) &#123;</span><br><span class="line">        <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// no match</span></span><br><span class="line">  <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹ä¼šæ‰§è¡Œ<code>normalizeLocation</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„<code>location</code>ï¼Œçœ‹ä¸€çœ¼<code>normalizeLocation</code>çš„å®ç°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeLocation</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  raw: RawLocation,</span></span></span><br><span class="line"><span class="function"><span class="params">  current: ?Route,</span></span></span><br><span class="line"><span class="function"><span class="params">  append: ?boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  router: ?VueRouter</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Location</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next: Location = <span class="keyword">typeof</span> raw === <span class="string">'string'</span> ? &#123; <span class="attr">path</span>: raw &#125; : raw</span><br><span class="line">  <span class="comment">// named target</span></span><br><span class="line">  <span class="keyword">if</span> (next._normalized) &#123;</span><br><span class="line">    <span class="comment">// å·²ç»normalizedçš„ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next.name) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å‘½åè·¯ç”±ï¼Œè¿”å›ä¸€ä»½å¤‡ä»½</span></span><br><span class="line">    <span class="keyword">return</span> extend(&#123;&#125;, raw)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// relative params</span></span><br><span class="line">  <span class="comment">// æ²¡æœ‰pathï¼Œä½†æ˜¯æœ‰paramså’Œcurrent</span></span><br><span class="line">  <span class="keyword">if</span> (!next.path &amp;&amp; next.params &amp;&amp; current) &#123;</span><br><span class="line">    next = extend(&#123;&#125;, next)</span><br><span class="line">    next._normalized = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°params</span></span><br><span class="line">    <span class="keyword">const</span> params: any = extend(extend(&#123;&#125;, current.params), next.params)</span><br><span class="line">    <span class="keyword">if</span> (current.name) &#123;</span><br><span class="line">      next.name = current.name</span><br><span class="line">      next.params = params</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current.matched.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> rawPath = current.matched[current.matched.length - <span class="number">1</span>].path</span><br><span class="line">      <span class="comment">// æ ¹æ®rawPathå’Œparamsè®¡ç®—å‡ºå½“å‰path</span></span><br><span class="line">      next.path = fillParams(rawPath, params, <span class="string">`path <span class="subst">$&#123;current.path&#125;</span>`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="literal">false</span>, <span class="string">`relative params navigation requires a current route.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†pathæ‹†åˆ†æˆpathã€hashå’Œquery</span></span><br><span class="line">  <span class="keyword">const</span> parsedPath = parsePath(next.path || <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> basePath = (current &amp;&amp; current.path) || <span class="string">'/'</span></span><br><span class="line">  <span class="comment">// è¿”å›æœ€åæ‹¼æ¥å®Œæˆå¥½çš„è·¯å¾„ï¼Œappendç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨å½“å‰ (ç›¸å¯¹) è·¯å¾„å‰æ·»åŠ åŸºè·¯å¾„</span></span><br><span class="line">  <span class="keyword">const</span> path = parsedPath.path</span><br><span class="line">    ? resolvePath(parsedPath.path, basePath, append || next.append)</span><br><span class="line">    : basePath</span><br><span class="line">  <span class="comment">// è§£æquery parseQueryæ˜¯æä¾›è‡ªå®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²çš„è§£æ/åè§£æå‡½æ•°ï¼Œç”¨äºè¦†ç›–é»˜è®¤è¡Œä¸º</span></span><br><span class="line">  <span class="keyword">const</span> query = resolveQuery(</span><br><span class="line">    parsedPath.query,</span><br><span class="line">    next.query,</span><br><span class="line">    router &amp;&amp; router.options.parseQuery</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// è·¯ç”±çš„hashå€¼</span></span><br><span class="line">  <span class="keyword">let</span> hash = next.hash || parsedPath.hash</span><br><span class="line">  <span class="keyword">if</span> (hash &amp;&amp; hash.charAt(<span class="number">0</span>) !== <span class="string">'#'</span>) &#123;</span><br><span class="line">    hash = <span class="string">`#<span class="subst">$&#123;hash&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    _normalized: <span class="literal">true</span>,</span><br><span class="line">    path,</span><br><span class="line">    query,</span><br><span class="line">    hash</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­å½“å‰çš„<code>RawLocation</code>æ˜¯å¦å·²ç»ç»è¿‡<code>_normalized</code>å¤„ç†ï¼Œæ˜¯çš„è¯ç›´æ¥è¿”å›ï¼Œå¦åˆ™çš„è¯ç»§ç»­åˆ¤æ–­å½“å‰<code>Location</code>æ˜¯å¦æœ‰<code>name</code>å­—æ®µï¼Œæœ‰çš„è¯é€šè¿‡<code>extend</code>æ–¹æ³•æ‹·è´ä¸€ä»½<code>raw</code>å¯¹è±¡ç›´æ¥è¿”å›ï¼Œè¿™ä¸ª<code>extend</code>æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">extend</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> b) &#123;</span><br><span class="line">    a[key] = b[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä¸Šé¢çš„æƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œæ¥ç€è¿›å…¥ä¸‹ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå¦‚æœæœ‰å½“å‰<code>Route</code>ä¿¡æ¯ï¼Œæœ‰<code>params</code>ä½†æ˜¯æ²¡æœ‰<code>path</code>çš„æƒ…å†µï¼Œé¦–å…ˆä¼šè®¾ç½®<code>_normalized</code>æ ‡å¿—ä½ï¼Œç„¶åå¯¹<code>params</code>å‚æ•°è¿›è¡Œåˆå¹¶å¤„ç†ï¼Œç„¶åç»§ç»­åˆ†ä¸ºä¸¤ç§æƒ…å†µå¤„ç†ï¼Œåˆ†åˆ«æ˜¯<code>current</code>æœ‰<code>name</code>ä¸å¦ï¼Œå‰è€…çš„è¯ä¼šç›´æ¥å°†<code>current</code>çš„<code>name</code>å’Œæ‹¼æ¥åçš„<code>params</code>èµ‹å€¼ç»™<code>next</code>åç›´æ¥è¿”å›ï¼Œåè€…çš„è¯ä¼šä»è·¯ç”±è®°å½•é‡Œé¢æ‰¾åˆ°æœ€æ–°çš„ä¸€æ¡è®°å½•çš„<code>path</code>ï¼Œè°ƒç”¨<code>fillParams</code>æ–¹æ³•æ ¹æ®<code>rawPath</code>å’Œ<code>params</code>è®¡ç®—å½“å‰<code>path</code>ï¼Œçœ‹ä¸€ä¸‹<code>fillParams</code>å¯¹ç›¸å¯¹è·¯å¾„çš„å¤„ç†ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; warn &#125; <span class="keyword">from</span> <span class="string">'./warn'</span></span><br><span class="line"><span class="keyword">import</span> Regexp <span class="keyword">from</span> <span class="string">'path-to-regexp'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// $flow-disable-line</span></span><br><span class="line"><span class="keyword">const</span> regexpCompileCache: &#123;</span><br><span class="line">  [key: string]: <span class="built_in">Function</span></span><br><span class="line">&#125; = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fillParams</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  path: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  params: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  routeMsg: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  params = params || &#123;&#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> filler =</span><br><span class="line">      regexpCompileCache[path] ||</span><br><span class="line">      (regexpCompileCache[path] = Regexp.compile(path))</span><br><span class="line">    <span class="comment">// å¦‚æœparamä¸­æœ‰åä¸ºpathMatchçš„keyå°†ä»–è®¾ç½®ä¸º&#123;0, params[patchMatch]&#125;çš„é”®å€¼å¯¹</span></span><br><span class="line">    <span class="comment">// Fix #2505 resolving asterisk routes &#123; name: 'not-found', params: &#123; pathMatch: '/not-found' &#125;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (params.pathMatch) params[<span class="number">0</span>] = params.pathMatch</span><br><span class="line">    <span class="comment">// å°†åŠ¨æ€è·¯å¾„å‚æ•°æ›¿æ¢æˆæ­£å¼å‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> filler(params, &#123; <span class="attr">pretty</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="literal">false</span>, <span class="string">`missing param for <span class="subst">$&#123;routeMsg&#125;</span>: <span class="subst">$&#123;e.message&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// delete the 0 if it was added</span></span><br><span class="line">    <span class="keyword">delete</span> params[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®è¿™é‡Œå°±æ˜¯æŠŠå½¢å¦‚<code>{zapId: 1}</code>çš„paramså‚æ•°é€šè¿‡<code>Regexp.compile</code>ç”Ÿæˆçš„æ–¹æ³•æ‹¼æ¥åˆ°<code>path</code>åé¢ï¼Œå°±åƒè¿™æ ·ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toPath = pathToRegexp.compile(<span class="string">'/user/:id'</span>)</span><br><span class="line"></span><br><span class="line">toPath(&#123; <span class="attr">id</span>: <span class="number">123</span> &#125;) <span class="comment">//=&gt; "/user/123"</span></span><br></pre></td></tr></table></figure>
<p>å›åˆ°<code>create-matcher.js</code>ï¼Œè®¡ç®—å‡ºæ–°çš„<code>location</code>ä¹‹åå¯¹å‘½åè·¯ç”±å’Œéå‘½åè·¯ç”±è¿›è¡Œäº†ä¸åŒçš„å¤„ç†ï¼Œå¦‚æœ<code>name</code>å­˜åœ¨ï¼Œä»<code>nameMap</code>å­—å…¸é‡Œé¢åŒ¹é…å‡ºå¯¹åº”çš„<code>record</code>ï¼Œå¦‚æœ<code>record</code>ä¸å­˜åœ¨é€šè¿‡<code>_createRoute</code>ç”Ÿæˆä¸€æ¡æ–°çš„<code>record</code>ç›´æ¥è¿”å›ï¼Œå¦åˆ™å–å‡ºè¿™æ¡<code>record</code>é‡Œé¢çš„<code>params</code>çš„<code>key</code>ç»„æˆçš„æ•°ç»„ï¼Œå°†<code>currentRoute</code>é‡Œé¢çš„<code>params</code>ä»¥<code>key</code>/<code>value</code>çš„å½¢å¼ä¸é‡å¤åœ°å­˜å…¥åä¸º<code>location.params</code>çš„ä¸€ä¸ªå¯¹è±¡é‡Œé¢ï¼Œæœ€åä¾ç„¶æ˜¯é€šè¿‡<code>fillParams</code>æ‹¼æ¥<code>params</code>å‚æ•°åˆ°è·¯å¾„å°¾éƒ¨ï¼Œé€šè¿‡<code>_createRoute</code>æ–¹æ³•åˆ›å»ºä¸€æ¡æ–°è·¯å¾„è¿”å›ã€‚</p>
<p>åä¹‹ï¼Œå¦‚æœæ˜¯éå‘½åè·¯ç”±ï¼Œä¼šé€šè¿‡<code>pathList</code>è¿”å›<code>path</code>å¯¹åº”çš„<code>record</code>ï¼Œç„¶åé€šè¿‡<code>createRoute</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦èƒ½å¤ŸåŒ¹é…åˆ°è·¯ç”±ä¿¡æ¯ï¼Œæ˜¯çš„è¯ä¹Ÿä¼šé€šè¿‡<code>_createRoute</code>ç”Ÿæˆä¸€æ¡æ–°è·¯å¾„è¿”å›ã€‚æ¥ä¸‹æ¥åªè¦ææ‡‚<code>matchRoute</code>å’Œ<code>_createRoute</code>å¹²äº†ä»€ä¹ˆå°±è¡Œäº†ï¼Œå…ˆçœ‹<code>matchRoute</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchRoute</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  regex: RouteRegExp,</span></span></span><br><span class="line"><span class="function"><span class="params">  path: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  params: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> m = path.match(regex)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, len = m.length; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = regex.keys[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">const</span> val = <span class="keyword">typeof</span> m[i] === <span class="string">'string'</span> ? <span class="built_in">decodeURIComponent</span>(m[i]) : m[i]</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">      <span class="comment">// Fix #1994: using * with props: true generates a param named 0</span></span><br><span class="line">      params[key.name || <span class="string">'pathMatch'</span>] = val</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯é€šè¿‡<code>match</code>æ–¹æ³•åšåˆ¤æ–­ï¼Œå¦‚æœæ²¡åŒ¹é…åˆ°ç›´æ¥è¿”å›<code>false</code>ï¼Œå¦‚æœä¼ å…¥äº†<code>params</code>ä¼šå°†<code>path</code>é‡Œé¢çš„<code>params</code>ä»¥<code>key</code>/<code>value</code>å½¢å¼å­˜å…¥ï¼Œè¿™ä¸ªä¼ å…¥çš„<code>params</code>åœ¨è¿™é‡Œæ˜¯<code>location.params</code>æ‰€ä»¥å’Œå‰é¢åšçš„æ˜¯ä¸€æ ·çš„æ“ä½œã€‚</p>
<p>æ¥ç€çœ‹<code>_createRoute</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿåœ¨<code>create_matcher.js</code>å†…éƒ¨ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createRoute</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom?: Location</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">    <span class="keyword">return</span> redirect(record, redirectedFrom || location)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (record &amp;&amp; record.matchAs) &#123;</span><br><span class="line">    <span class="keyword">return</span> alias(record, location, record.matchAs)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> createRoute(record, location, redirectedFrom, router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯å¦è®¾ç½®äº†<code>redirect</code>è¿˜æ˜¯<code>alias</code>æœ€åéƒ½ä¼šé‡æ–°è°ƒç”¨<code>_createRoute</code>ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥çœ‹æœ€åçš„<code>createRoute</code>æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> type VueRouter <span class="keyword">from</span> <span class="string">'../index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; stringifyQuery &#125; <span class="keyword">from</span> <span class="string">'./query'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trailingSlashRE = <span class="regexp">/\/?$/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoute</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  location: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom?: ?Location,</span></span></span><br><span class="line"><span class="function"><span class="params">  router?: VueRouter</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æä¾›è‡ªå®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²çš„è§£æ/åè§£æå‡½æ•°ã€‚è¦†ç›–é»˜è®¤è¡Œä¸º</span></span><br><span class="line">  <span class="keyword">const</span> stringifyQuery = router &amp;&amp; router.options.stringifyQuery</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> query: any = location.query || &#123;&#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    query = clone(query)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> route: Route = &#123;</span><br><span class="line">    name: location.name || (record &amp;&amp; record.name),</span><br><span class="line">    meta: (record &amp;&amp; record.meta) || &#123;&#125;,</span><br><span class="line">    path: location.path || <span class="string">'/'</span>,</span><br><span class="line">    hash: location.hash || <span class="string">''</span>,</span><br><span class="line">    query,</span><br><span class="line">    params: location.params || &#123;&#125;,</span><br><span class="line">    fullPath: getFullPath(location, stringifyQuery), <span class="comment">// å®Œæ•´è·¯å¾„</span></span><br><span class="line">    matched: record ? formatMatch(record) : []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (redirectedFrom) &#123;</span><br><span class="line">    route.redirectedFrom = getFullPath(redirectedFrom, stringifyQuery)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.freeze(route)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clone</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> value.map(clone)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">      res[key] = clone(value[key])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the starting route that represents the initial state</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> START = createRoute(<span class="literal">null</span>, &#123;</span><br><span class="line">  path: <span class="string">'/'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatMatch</span> (<span class="params">record: ?RouteRecord</span>): <span class="title">Array</span>&lt;<span class="title">RouteRecord</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="keyword">while</span> (record) &#123;</span><br><span class="line">    res.unshift(record)</span><br><span class="line">    record = record.parent</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFullPath</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; path, query = &#123;&#125;, hash = <span class="string">''</span> &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  _stringifyQuery</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stringify = _stringifyQuery || stringifyQuery</span><br><span class="line">  <span class="keyword">return</span> (path || <span class="string">'/'</span>) + stringify(query) + hash</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isSameRoute</span> (<span class="params">a: Route, b: ?Route</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (b === START) &#123;</span><br><span class="line">    <span class="keyword">return</span> a === b</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.path &amp;&amp; b.path) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      a.path.replace(trailingSlashRE, <span class="string">''</span>) === b.path.replace(trailingSlashRE, <span class="string">''</span>) &amp;&amp;</span><br><span class="line">      a.hash === b.hash &amp;&amp;</span><br><span class="line">      isObjectEqual(a.query, b.query)</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.name &amp;&amp; b.name) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      a.name === b.name &amp;&amp;</span><br><span class="line">      a.hash === b.hash &amp;&amp;</span><br><span class="line">      isObjectEqual(a.query, b.query) &amp;&amp;</span><br><span class="line">      isObjectEqual(a.params, b.params)</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObjectEqual</span> (<span class="params">a = &#123;&#125;, b = &#123;&#125;</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// handle null value #1566</span></span><br><span class="line">  <span class="keyword">if</span> (!a || !b) <span class="keyword">return</span> a === b</span><br><span class="line">  <span class="keyword">const</span> aKeys = <span class="built_in">Object</span>.keys(a)</span><br><span class="line">  <span class="keyword">const</span> bKeys = <span class="built_in">Object</span>.keys(b)</span><br><span class="line">  <span class="keyword">if</span> (aKeys.length !== bKeys.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> aKeys.every(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> aVal = a[key]</span><br><span class="line">    <span class="keyword">const</span> bVal = b[key]</span><br><span class="line">    <span class="comment">// check nested equality</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> aVal === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> bVal === <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> isObjectEqual(aVal, bVal)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(aVal) === <span class="built_in">String</span>(bVal)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isIncludedRoute</span> (<span class="params">current: Route, target: Route</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    current.path.replace(trailingSlashRE, <span class="string">'/'</span>).indexOf(</span><br><span class="line">      target.path.replace(trailingSlashRE, <span class="string">'/'</span>)</span><br><span class="line">    ) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    (!target.hash || current.hash === target.hash) &amp;&amp;</span><br><span class="line">    queryIncludes(current.query, target.query)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queryIncludes</span> (<span class="params">current: Dictionary&lt;string&gt;, target: Dictionary&lt;string&gt;</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> target) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> current)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¼ å…¥çš„<code>record</code>å’Œ<code>location</code>åˆ›å»ºä¸€ä¸ªä¸å¯è¢«ä¿®æ”¹çš„<code>Route</code>å¯¹è±¡ï¼Œå…¶ä¸­æœ‰ä¸ª<code>matched</code>å±æ€§é€šè¿‡<code>formatMatch</code>æ–¹æ³•æ„å»ºï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatMatch</span> (<span class="params">record: ?RouteRecord</span>): <span class="title">Array</span>&lt;<span class="title">RouteRecord</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="keyword">while</span> (record) &#123;</span><br><span class="line">    res.unshift(record)</span><br><span class="line">    record = record.parent</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å¾ªç¯ä¸æ–­åœ°æŸ¥æ‰¾å½“å‰<code>record</code>çš„<code>parent</code>ï¼Œç„¶åè¿”å›è¿™æ¡çº¿ä¸Šæ‰€æœ‰çš„<code>record</code>ç»„æˆçš„æ•°ç»„ã€‚</p>
<h5 id="è·¯ç”±çš„è·³è½¬"><a href="#è·¯ç”±çš„è·³è½¬" class="headerlink" title="è·¯ç”±çš„è·³è½¬"></a>è·¯ç”±çš„è·³è½¬</h5><p>æ— è®ºæ˜¯<code>Hash</code>è·¯ç”±è¿˜æ˜¯<code>History</code>è·¯ç”±ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™éƒ½ä¼šé€šè¿‡<code>transitionTo</code>æ–¹æ³•è·³è½¬åˆ°åˆå§‹è·¯å¾„ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æˆ‘ä»¬åˆ‡æ¢è·¯ç”±è·¯å¾„æ—¶å€™ä½¿ç”¨çš„æ–¹æ³•ï¼Œä¸‹é¢åˆ†æä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°è¿‡ç¨‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">transitionTo (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">   <span class="comment">// é€šè¿‡locationå’Œcurrentè¿”å›åˆå§‹åŒ–Routeä¿¡æ¯</span></span><br><span class="line">   <span class="keyword">const</span> route = <span class="keyword">this</span>.router.match(location, <span class="keyword">this</span>.current)</span><br><span class="line">   <span class="keyword">this</span>.confirmTransition(route, () =&gt; &#123;</span><br><span class="line">     <span class="keyword">this</span>.updateRoute(route)</span><br><span class="line">     <span class="comment">// æ‰§è¡ŒonCompleteå›è°ƒ</span></span><br><span class="line">     onComplete &amp;&amp; onComplete(route)</span><br><span class="line">     <span class="keyword">this</span>.ensureURL()</span><br><span class="line"></span><br><span class="line">     <span class="comment">// fire ready cbs once</span></span><br><span class="line">     <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) &#123;</span><br><span class="line">       <span class="keyword">this</span>.ready = <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.readyCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb(route) &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;, err =&gt; &#123;</span><br><span class="line">     <span class="comment">// å¦‚æœè·³è½¬è¢«ç»ˆæ­¢</span></span><br><span class="line">     <span class="keyword">if</span> (onAbort) &#123;</span><br><span class="line">       onAbort(err)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (err &amp;&amp; !<span class="keyword">this</span>.ready) &#123;</span><br><span class="line">       <span class="keyword">this</span>.ready = <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.readyErrorCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb(err) &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–è°ƒç”¨çš„æ—¶å€™ï¼Œæ‹¿åˆ°çš„æ˜¯åˆå§‹åŒ–çš„<code>Route</code>ï¼Œé€šè¿‡<code>confirmTransition</code>æ–¹æ³•è¿›è¡Œå®é™…çš„è·³è½¬æ“ä½œï¼ŒåŒæ—¶å¯¹è·³è½¬æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µéƒ½è®¾ç½®äº†å›è°ƒå‡½æ•°ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®šä¹‰ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">confirmTransition (route: Route, <span class="attr">onComplete</span>: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = <span class="keyword">this</span>.current</span><br><span class="line">  <span class="keyword">const</span> abort = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isError(err)) &#123;</span><br><span class="line">      <span class="comment">// å°†æ‰€æœ‰çš„é”™è¯¯ä¿¡æ¯éƒ½å­˜å…¥errorCbs</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.errorCbs.length) &#123;</span><br><span class="line">        <span class="keyword">this</span>.errorCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb(err) &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warn(<span class="literal">false</span>, <span class="string">'uncaught error during route navigation:'</span>)</span><br><span class="line">        <span class="built_in">console</span>.error(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    onAbort &amp;&amp; onAbort(err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åŒä¸€ä¸ªè·¯ç”±è·¯å¾„</span></span><br><span class="line">    isSameRoute(route, current) &amp;&amp;</span><br><span class="line">    <span class="comment">// in the case the route map has been dynamically appended to</span></span><br><span class="line">    route.matched.length === current.matched.length</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// ensureURLåœ¨ä¸åŒçš„è·¯ç”±å®ç°æ–¹å¼é‡Œé¢è¯¥æ–¹æ³•çš„å®ç°ä¸ä¸€æ ·</span></span><br><span class="line">    <span class="keyword">this</span>.ensureURL()</span><br><span class="line">    <span class="comment">// å¦‚æœè®¾ç½®äº†abortæ–¹æ³•è¿™é‡Œç›´æ¥è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> abort()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°è·¯å¾„çš„å˜åŒ–éƒ¨åˆ†ä»¥åŠé—å¼ƒéƒ¨åˆ†å’Œå‡çº§éƒ¨åˆ†</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    updated,</span><br><span class="line">    deactivated,</span><br><span class="line">    activated</span><br><span class="line">  &#125; = resolveQueue(<span class="keyword">this</span>.current.matched, route.matched)</span><br><span class="line">  <span class="comment">// ç»´æŒä¸€ä¸ªå¯¹åº”è·¯å¾„å˜åŒ–çš„å¯¼èˆªå®ˆå«çš„é’©å­ç»„æˆçš„List</span></span><br><span class="line">  <span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">    <span class="comment">// in-component leave guards</span></span><br><span class="line">    extractLeaveGuards(deactivated),</span><br><span class="line">    <span class="comment">// global before hooks</span></span><br><span class="line">    <span class="keyword">this</span>.router.beforeHooks,</span><br><span class="line">    <span class="comment">// in-component update hooks</span></span><br><span class="line">    extractUpdateHooks(updated),</span><br><span class="line">    <span class="comment">// in-config enter guards</span></span><br><span class="line">    activated.map(<span class="function"><span class="params">m</span> =&gt;</span> m.beforeEnter),</span><br><span class="line">    <span class="comment">// async components</span></span><br><span class="line">    resolveAsyncComponents(activated)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pending = route</span><br><span class="line">  <span class="comment">// å®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨</span></span><br><span class="line">  <span class="keyword">const</span> iterator = <span class="function">(<span class="params">hook: NavigationGuard, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</span><br><span class="line">      <span class="keyword">return</span> abort()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      hook(route, current, (to: any) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (to === <span class="literal">false</span> || isError(to)) &#123;</span><br><span class="line">          <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">          <span class="keyword">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">          abort(to)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">          <span class="keyword">typeof</span> to === <span class="string">'string'</span> ||</span><br><span class="line">          (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp; (</span><br><span class="line">            <span class="keyword">typeof</span> to.path === <span class="string">'string'</span> ||</span><br><span class="line">            <span class="keyword">typeof</span> to.name === <span class="string">'string'</span></span><br><span class="line">          ))</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// next('/') or next(&#123; path: '/' &#125;) -&gt; redirect</span></span><br><span class="line">          abort()</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp; to.replace) &#123;</span><br><span class="line">            <span class="keyword">this</span>.replace(to)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.push(to)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// ç¡®è®¤è·³è½¬ï¼Œæ‰§è¡Œå›è°ƒ</span></span><br><span class="line">          <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">          next(to)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      abort(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> postEnterCbs = []</span><br><span class="line">    <span class="keyword">const</span> isValid = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.current === route</span><br><span class="line">    <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">    <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒbeforeRouteEnteré’©å­å‡½æ•°</span></span><br><span class="line">    <span class="keyword">const</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)</span><br><span class="line">    <span class="keyword">const</span> queue = enterGuards.concat(<span class="keyword">this</span>.router.resolveHooks)</span><br><span class="line">    runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</span><br><span class="line">        <span class="keyword">return</span> abort()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.pending = <span class="literal">null</span></span><br><span class="line">      onComplete(route)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.router.app) &#123;</span><br><span class="line">        <span class="keyword">this</span>.router.app.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          postEnterCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb() &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>abort</code>å‡½æ•°ç”¨äºå¤„ç†è·¯ç”±è·³è½¬å¤±è´¥çš„æƒ…å†µä»¥åŠæ‰§è¡Œ<code>onAbort</code>å›è°ƒï¼Œç„¶ååˆ¤æ–­å¦‚æœè¦è·³è½¬çš„è·¯ç”±å’Œå½“å‰è·¯ç”±æ˜¯åŒä¸€ä¸ªçš„è¯ï¼Œç›´æ¥è°ƒç”¨<code>this.ensureURL()</code>å’Œ<code>abort()</code>ï¼Œè¿™ä¸ª<code>ensureURL</code>åœ¨ä¸åŒçš„è·¯ç”±å®ç°æ–¹å¼é‡Œé¢è¯¥æ–¹æ³•çš„å®ç°ä¸ä¸€æ ·ï¼Œæœ€ç»ˆéƒ½æ˜¯åšäº†è·¯ç”±è·³è½¬çš„æ“ä½œï¼Œç´§æ¥ç€é€šè¿‡<code>resolveQueue</code>æ–¹æ³•æ‹¿åˆ°ä¸‰ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«å­˜å‚¨ç€å›ºå®šçš„éƒ¨åˆ†ï¼Œé—å¼ƒçš„éƒ¨åˆ†ä»¥åŠæ›´æ–°çš„éƒ¨åˆ†ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveQueue</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Array&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  next: Array&lt;RouteRecord&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): </span>&#123;</span><br><span class="line">  updated: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span><br><span class="line">  activated: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span><br><span class="line">  deactivated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="keyword">let</span> i</span><br><span class="line">  <span class="keyword">const</span> max = <span class="built_in">Math</span>.max(current.length, next.length)</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current[i] !== next[i]) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    updated: next.slice(<span class="number">0</span>, i),</span><br><span class="line">    activated: next.slice(i),</span><br><span class="line">    deactivated: current.slice(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·¯ç”±ä»<code>current</code>å˜ä¸º<code>next</code>ï¼Œä¸¤ä¸ªè·¯å¾„çš„å…¬å…±éƒ¨åˆ†å°±æ˜¯<code>next.slice(0, i)</code>ï¼Œ<code>next.slice(0, i)</code>å°±æ˜¯è·¯å¾„éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ï¼Œè€Œ<code>current.slice(i)</code>å°±æ˜¯è·¯å¾„éœ€è¦å˜åŒ–çš„éƒ¨åˆ†ã€‚</p>
<p>æ‹¿åˆ°ä¸‰ä¸ªæ•°ç»„ä¹‹åä¼šæ„é€ ä¸€ä¸ª<code>queue</code>é˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†è·¯å¾„å˜åŒ–è¦æ‰§è¡Œçš„é’©å­å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å®˜æ–¹è¯´çš„è·¯ç”±å®ˆå«ï¼Œä¼šæŒ‰æ¬¡åºæ‰§è¡Œä¸€äº›è¯¸å¦‚<code>beforeRouteLeave</code>ã€<code>beforeRouteUpdate</code>ç­‰æ–¹æ³•ï¼Œä¸‹é¢è¿˜ä¼šå®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¿™ä¸ªè¿­ä»£å™¨ä¼šæ ¹æ®ä¼ å…¥çš„<code>ro</code>å‚æ•°æ¥å†³å®šæ‰§è¡Œ<code>abort</code>è¿˜æ˜¯<code>next</code>æ–¹æ³•ï¼Œæœ€åæ‰§è¡Œ<code>runQueue</code>æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runQueue</span> (<span class="params">queue: Array&lt;?NavigationGuard&gt;, fn: Function, cb: Function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> step = <span class="function"><span class="params">index</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= queue.length) &#123;</span><br><span class="line">      cb()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue[index]) &#123;</span><br><span class="line">        fn(queue[index], () =&gt; &#123;</span><br><span class="line">          step(index + <span class="number">1</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        step(index + <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  step(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>fn</code>å…¶å®å°±æ˜¯<code>iterator</code>é‡Œé¢çš„<code>next</code>å‡½æ•°ï¼Œåªæœ‰æ‰§è¡Œäº†<code>next</code>å‡½æ•°<code>index</code>æ‰ä¼š<code>+1</code>ï¼Œæ‰ä¼šè¿›è¡Œç®¡é“ä¸­çš„ä¸‹ä¸€ä¸ªé’©å­ï¼Œå¦‚æœå…¨éƒ¨é’©å­æ‰§è¡Œå®Œäº†ï¼Œåˆ™å¯¼èˆªçš„çŠ¶æ€ä¼šå˜æˆ<code>confirmed</code>(ç¡®è®¤çš„)ã€‚</p>
<p>æœ€åå¯ä»¥çœ‹ä¸€ä¸‹<code>Vue-Router</code>é‡Œé¢å¯¹å¯¼èˆªçš„å®Œæ•´è§£ææµç¨‹ï¼š</p>
<blockquote>
<p>å¯¼èˆªè¢«è§¦å‘ã€‚<br>åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ç¦»å¼€å®ˆå«ã€‚<br>è°ƒç”¨å…¨å±€çš„ beforeEach å®ˆå«ã€‚<br>åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteUpdate å®ˆå« (2.2+)ã€‚<br>åœ¨è·¯ç”±é…ç½®é‡Œè°ƒç”¨ beforeEnterã€‚<br>è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚<br>åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteEnterã€‚<br>è°ƒç”¨å…¨å±€çš„ beforeResolve å®ˆå« (2.5+)ã€‚<br>å¯¼èˆªè¢«ç¡®è®¤ã€‚<br>è°ƒç”¨å…¨å±€çš„ afterEach é’©å­ã€‚<br>è§¦å‘ DOM æ›´æ–°ã€‚<br>ç”¨åˆ›å»ºå¥½çš„å®ä¾‹è°ƒç”¨ beforeRouteEnter å®ˆå«ä¸­ä¼ ç»™ next çš„å›è°ƒå‡½æ•°ã€‚</p>
</blockquote>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ä¼ ç»Ÿçš„è·¯ç”±å®ç°æ˜¯é€šè¿‡å¯¹è·¯å¾„çš„åˆ‡æ¢åšåˆ°çš„ï¼Œå¯¹äº<code>Vue-Router</code>è€Œè¨€ï¼Œè·¯ç”±æ¨¡å—çš„æœ¬è´¨ å°±æ˜¯å»ºç«‹èµ·urlå’Œé¡µé¢ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚è·¯ç”±å§‹ç»ˆä¼šç»´æŠ¤å½“å‰çš„çº¿è·¯ï¼Œè·¯ç”±åˆ‡æ¢çš„æ—¶å€™ä¼šæŠŠå½“å‰çº¿è·¯åˆ‡æ¢åˆ°ç›®æ ‡çº¿è·¯ï¼Œåˆ‡æ¢è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„å¯¼èˆªå®ˆå«é’©å­å‡½æ•°ï¼Œä¼šæ›´æ”¹<code>url</code>ï¼ŒåŒæ ·ä¹Ÿä¼šæ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ï¼Œåˆ‡æ¢å®Œæ¯•åä¼šæŠŠç›®æ ‡çº¿è·¯æ›´æ–°æ›¿æ¢å½“å‰çº¿è·¯ï¼Œè¿™æ ·å°±ä¼šä½œä¸ºä¸‹ä¸€æ¬¡çš„è·¯å¾„åˆ‡æ¢çš„ä¾æ®.</p>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://ustbhuangyi.github.io/vue-analysis/vue-router/" target="_blank" rel="noopener">Vueæ ¸å¿ƒè§£å¯†</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:lin794653318@gmail.com">æç‰§ç¾Š</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.limuyang.cc/2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /">https://www.limuyang.cc/2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.limuyang.cc" target="_blank">Atlantis</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/javascript/">javascript</a><a class="post-meta__tags" href="/tags/vue-router/">vue-router</a><a class="post-meta__tags" href="/tags/æºç é˜…è¯»/">æºç é˜…è¯»</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://www.tuchuang001.com/images/2018/04/28/_20180428235252.png"><div class="post-qr-code__desc"></div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/06/19/é˜…è¯»åˆ†æReact-Reduxæºç /"><i class="fa fa-chevron-left">  </i><span>é˜…è¯»åˆ†æReact-Reduxæºç </span></a></div><div class="next-post pull-right"><a href="/2019/04/23/å®ç°ä¸€ä¸ªç¬¦åˆPromise-A-è§„èŒƒçš„Promise/"><span>å®ç°ä¸€ä¸ªç¬¦åˆPromise/A+è§„èŒƒçš„Promise</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.limuyang.cc/2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /';
  this.page.identifier = '2019/05/09/é˜…è¯»åˆ†æVue-Routeræºç /';
  this.page.title = 'é˜…è¯»åˆ†æVue-Routeræºç ';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'atlantics1013' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://atlantics1013.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By æç‰§ç¾Š</div><div class="framework-info"><span>é©±åŠ¨ - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>